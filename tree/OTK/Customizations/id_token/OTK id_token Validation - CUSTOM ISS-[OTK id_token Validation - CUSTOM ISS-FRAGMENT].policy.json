{
  "goid": "bc9a31b7578652a08a514d7d4fef276a",
  "guid": "99ab9e0f-5b60-45d5-8148-f345ad57237d",
  "name": "OTK id_token Validation - CUSTOM ISS",
  "policyType": "FRAGMENT",
  "checksum": "0b8e79994be7fc18843bebd6a5c3f4e10c371b13",
  "folderPath": "/OTK/Customizations/id_token",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== Target Policy:  &quot;OTK id_token Validation&quot;\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== The policy is executed when the decoded JWT issuer does NOT match the iss specified in &quot;#OTK id_token configuration&quot; and the \"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${id_token_signing_algorithm} variable is set to CUSTOM\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"This policy validates a JWT based on CUSTOM ISS.  Implement your CUSTOM ISS id_token validation below.\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== the policy must export:\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${didt.sub}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${didt.aud}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${didt.exp}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${didt.azp}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${didt.acr}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${resource_owner}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== ${salt}\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== after setting the above variables, enable the export assertion below\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== and set each variable to be exported\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"This branch is used with [mag] if the enrollment feature is used\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"Update this branch to your needs\"/>\n                </L7p:CommentAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// Has to match the 'iss' value in MAG Device Enrollment Configuration\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${didt.iss}\"/>\n                    <L7p:Expression2 stringValue=\"https://enrollment.gateway.ca.com\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"https://enrollment.gateway.ca.com\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${shared_secret_alg}\"/>\n                            <L7p:Expression2 stringValue=\"HS256\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:RightValue stringValue=\"HS256\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:DecodeJsonWebToken>\n                            <L7p:SignatureSecret stringValue=\"${shared_secret}\"/>\n                            <L7p:SourcePayload stringValue=\"${jwt}\"/>\n                            <L7p:TargetVariablePrefix stringValue=\"sessionDataOutput\"/>\n                            <L7p:ValidationType stringValue=\"Using Secret\"/>\n                        </L7p:DecodeJsonWebToken>\n                        <L7p:ComparisonAssertion>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// Verify the signature validation result\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${sessionDataOutput.valid}\"/>\n                            <L7p:Expression2 stringValue=\"true\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:RightValue stringValue=\"true\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// HS256\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${shared_secret_alg}\"/>\n                            <L7p:Expression2 stringValue=\"RS256\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:RightValue stringValue=\"RS256\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:LookupTrustedCertificate>\n                            <L7p:AllowMultipleCertificates booleanValue=\"false\"/>\n                            <L7p:TrustedCertificateName stringValue=\"${shared_secret}\"/>\n                            <L7p:VariableName stringValue=\"cert\"/>\n                        </L7p:LookupTrustedCertificate>\n                        <L7p:DecodeJsonWebToken>\n                            <L7p:KeyType stringValue=\"Certificate\"/>\n                            <L7p:PrivateKeySource stringValue=\"${cert}\"/>\n                            <L7p:SourcePayload stringValue=\"${jwt}\"/>\n                            <L7p:TargetVariablePrefix stringValue=\"sessionDataOutput\"/>\n                            <L7p:ValidationType stringValue=\"Using Recipient Key From Context Variable\"/>\n                        </L7p:DecodeJsonWebToken>\n                        <L7p:ComparisonAssertion>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// Verify the signature validation result\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${sessionDataOutput.valid}\"/>\n                            <L7p:Expression2 stringValue=\"true\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:RightValue stringValue=\"true\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// RS256\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:AuditDetailAssertion>\n                            <L7p:Detail stringValue=\"The enrollment sessionData validation failed! Configured alg: '${enrollment_sig_alg}'\"/>\n                        </L7p:AuditDetailAssertion>\n                        <L7p:Encapsulated>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"132\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                            <L7p:Parameters mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"apiPrefix\"/>\n                                    <L7p:value stringValue=\"\"/>\n                                </L7p:entry>\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"givenErrorCode\"/>\n                                    <L7p:value stringValue=\"132\"/>\n                                </L7p:entry>\n                            </L7p:Parameters>\n                        </L7p:Encapsulated>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// error\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// validate against configured alg\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtzZXNzaW9uRGF0YU91dHB1dC5wYXlsb2FkfQ==\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"profile\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpression>\n                    <L7p:Expression stringValue=\"exp\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"profile\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"exp\"/>\n                </L7p:EvaluateJsonPathExpression>\n                <L7p:EvaluateJsonPathExpression>\n                    <L7p:Expression stringValue=\"aud\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"profile\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"aud\"/>\n                </L7p:EvaluateJsonPathExpression>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"==\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"Validate the id_token:\"/>\n                </L7p:CommentAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"audience\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// has to match the used client_id when this token was retrieved\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:Expression1 stringValue=\"${azp}\"/>\n                    <L7p:Expression2 stringValue=\"${aud.result}\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:RightValue stringValue=\"${aud.result}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"expiration\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// verify that the token has not expired\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${gateway.time.seconds}\"/>\n                    <L7p:Expression2 stringValue=\"${exp.result}\"/>\n                    <L7p:Operator operator=\"LE\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Operator operator=\"LE\"/>\n                            <L7p:RightValue stringValue=\"${exp.result}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"==\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"Extract user data:\"/>\n                </L7p:CommentAssertion>\n                <L7p:EvaluateJsonPathExpression>\n                    <L7p:Expression stringValue=\"sub\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"profile\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"sub\"/>\n                </L7p:EvaluateJsonPathExpression>\n                <L7p:EvaluateJsonPathExpression>\n                    <L7p:Expression stringValue=\"preferred_username\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"profile\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"preferred_username\"/>\n                </L7p:EvaluateJsonPathExpression>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtzdWIucmVzdWx0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"didt.sub\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHthdWQucmVzdWx0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"didt.aud\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtleHAucmVzdWx0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"didt.exp\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHthdWQucmVzdWx0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"didt.azp\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MQ==\"/>\n                    <L7p:VariableToSet stringValue=\"didt.acr\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtwcmVmZXJyZWRfdXNlcm5hbWUucmVzdWx0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"resource_owner\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"salt\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// specify a secret used with this provider only\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:Base64Expression stringValue=\"YXNlY3JldHZhbHVldGhhdGlza25vd25oZXJlb25seWFuZGFzZWNyZXQ=\"/>\n                    <L7p:VariableToSet stringValue=\"salt\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"[mag]\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// enrollment\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// custom iss\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:ExportVariables>\n            <L7p:ExportedVars stringArrayValue=\"included\">\n                <L7p:item stringValue=\"didt.acr\"/>\n                <L7p:item stringValue=\"didt.aud\"/>\n                <L7p:item stringValue=\"didt.azp\"/>\n                <L7p:item stringValue=\"didt.exp\"/>\n                <L7p:item stringValue=\"didt.sub\"/>\n                <L7p:item stringValue=\"resource_owner\"/>\n                <L7p:item stringValue=\"salt\"/>\n            </L7p:ExportedVars>\n        </L7p:ExportVariables>\n    </wsp:All>\n</wsp:Policy>"
  }
}