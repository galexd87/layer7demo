{
  "goid": "ebee4c48062f1aee5e746973993743c4",
  "guid": "b442591b-bafe-4be6-889e-75da1a3ca46f",
  "name": "#OTK Validate Token Exchange Audience And Scope",
  "policyType": "FRAGMENT",
  "checksum": "64a5c7933f43188e82686596a8f2b7efcb1e65b8",
  "folderPath": "/OTK/Customizations",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== Target Policy:  &quot;OTK grant_type=TOKEN_EXCHANGE&quot;\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"============================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Validate Audience And Scope ======================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Scope is validated for unprivileged clients ======================\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:Expression1 stringValue=\"${audience}\"/>\n                <L7p:Expression2 stringValue=\"\"/>\n                <L7p:Operator operator=\"EMPTY\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:RightValue stringValue=\"\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"00627d8a-396c-4274-a6f5-2119def8f354\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK RESOURCE Issuing - Extended\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"resource.permitted\"/>\n                        <L7p:value stringValue=\"${resource.registered}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"resource.requested\"/>\n                        <L7p:value stringValue=\"${audience}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MTYw\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// validate audience\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:Expression1 stringValue=\"${resource}\"/>\n                <L7p:Expression2 stringValue=\"\"/>\n                <L7p:Operator operator=\"EMPTY\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:RightValue stringValue=\"\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"00627d8a-396c-4274-a6f5-2119def8f354\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK RESOURCE Issuing - Extended\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"resource.permitted\"/>\n                        <L7p:value stringValue=\"${resource.granted}  ${resource}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"resource.requested\"/>\n                        <L7p:value stringValue=\"${resource.granted}  ${resource}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// append resource granted\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:Expression1 stringValue=\"${is_privileged_client}\"/>\n                <L7p:Expression2 stringValue=\"true\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:RightValue stringValue=\"true\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:ComparisonAssertion>\n                <L7p:Expression1 stringValue=\"${scope.permitted}\"/>\n                <L7p:Expression2 stringValue=\"\"/>\n                <L7p:Operator operator=\"EMPTY\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:RightValue stringValue=\"\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:CustomAssertion>\n                <L7p:base64SerializedValue>rO0ABXNyADFjb20ubDd0ZWNoLnBvbGljeS5hc3NlcnRpb24uQ3VzdG9tQXNzZXJ0aW9uSG9sZGVyZtcreFwddTICAAlaAAxpc1VpQXV0b09wZW5MAApjYXRlZ29yaWVzdAAPTGphdmEvdXRpbC9TZXQ7TAAIY2F0ZWdvcnl0ACpMY29tL2w3dGVjaC9wb2xpY3kvYXNzZXJ0aW9uL2V4dC9DYXRlZ29yeTtMAA9jdXN0b21Bc3NlcnRpb250ADFMY29tL2w3dGVjaC9wb2xpY3kvYXNzZXJ0aW9uL2V4dC9DdXN0b21Bc3NlcnRpb247TAAUY3VzdG9tTW9kdWxlRmlsZU5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztMAA9kZXNjcmlwdGlvblRleHRxAH4ABEwAD3BhbGV0dGVOb2RlTmFtZXEAfgAETAAOcG9saWN5Tm9kZU5hbWVxAH4ABEwAHnJlZ2lzdGVyZWRDdXN0b21GZWF0dXJlU2V0TmFtZXEAfgAEeHIAJWNvbS5sN3RlY2gucG9saWN5LmFzc2VydGlvbi5Bc3NlcnRpb27bX2OZPL2isQIAAloAB2VuYWJsZWRMABBhc3NlcnRpb25Db21tZW50dAAvTGNvbS9sN3RlY2gvcG9saWN5L2Fzc2VydGlvbi9Bc3NlcnRpb24kQ29tbWVudDt4cAFwAXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyAChjb20ubDd0ZWNoLnBvbGljeS5hc3NlcnRpb24uZXh0LkNhdGVnb3J5WrCcZaFE/jUCAAJJAAVteUtleUwABm15TmFtZXEAfgAEeHAAAAALdAAQQ3VzdG9tQXNzZXJ0aW9uc3hwc3IAMGNvbS5sN3RlY2guY3VzdG9tLmF1dGgyc2NvcGUuU2NvcGVJc3N1ZUFzc2VydGlvbi1huwlQ9D6wAgACTAAPc2NvcGVSZWdpc3RlcmVkcQB+AARMAA5zY29wZVJlcXVlc3RlZHEAfgAEeHB0ABIke3Njb3BlLnBlcm1pdHRlZH10ABAke3Njb3BlLmdyYW50ZWR9dAA0ZWYyYTMyZGY1OGVkZTQ1ZDI0MmM5ZmM5MzQwNmI3YmYwNjA3NDVjY2FkMmViZTVmLmphcnQAr1ZhbGlkYXRlcyB0aGUgcmVxdWVzdGVkIFNDT1BFIGFnYWluc3QgU0NPUEUncyB0aGF0IHdlcmUgcmVnaXN0ZXJlZCBmb3IgdGhlIGNsaWVudC4gSXQgb25seSBpc3N1ZXMgU0NPUEUncyB0aGF0IGFyZSBhIHN1YnNldCBvZiB0aGUgcmVnaXN0ZXJlZCBvbmVzLiBJdCB3aWxsIGZhaWwgaWYgbm9uZSBtYXRjaC50ABFPVEsgU0NPUEUgSXNzdWluZ3QAEU9USyBTQ09QRSBJc3N1aW5ncA==</L7p:base64SerializedValue>\n            </L7p:CustomAssertion>\n            <L7p:Encapsulated>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"115\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"${error.code}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// verify scope for unprivileged clients\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n    </wsp:All>\n</wsp:Policy>"
  }
}