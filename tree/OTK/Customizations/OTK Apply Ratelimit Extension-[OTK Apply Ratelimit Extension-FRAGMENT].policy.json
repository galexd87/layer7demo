{
  "goid": "ebf2739a2fd9cabd787ae8edb08bb814",
  "guid": "fd9342d8-5086-4758-8fd3-caa2df094448",
  "name": "OTK Apply Ratelimit Extension",
  "policyType": "FRAGMENT",
  "checksum": "b2a42f4e2fb66f3dff5118917db871cbf01bd1ee",
  "folderPath": "/OTK/Customizations",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Policy Fragment: OTK Apply Ratelimit Extension\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"=== The below Map Value Assertion contains OTK uris &amp; configuration with default values ===\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"=== 1. Request per second for each uri  ===\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"=== 2. Key to configure custom limit for each uri  ===\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"=== Set custom values for Rate limits by modifying the Map Value Assertion  ===\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:CaseSensitive booleanValue=\"false\"/>\n                <L7p:Expression1 stringValue=\"${gateway.otk.enforce_ratelimit}\"/>\n                <L7p:Operator operatorNull=\"null\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Negated booleanValue=\"true\"/>\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:RightValue stringValue=\"\"/>\n                    </L7p:item>\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"NE\"/>\n                        <L7p:RightValue stringValue=\"true\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"2e6e2ef3-a36f-4548-a2c4-7b369b7ae184\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Variable Configuration\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"custom\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n                <L7p:MapValue>\n                    <L7p:InputExpr stringValue=\"${request.url.path}\"/>\n                    <L7p:Mappings nameValuePairArray=\"included\">\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager/clients\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager/tokens\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_token_revocation_list_path}\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_token_path}\"/>\n                            <L7p:Value stringValue=\"100\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"auth/oauth/v2/client/export\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${userinfo_path}\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_device_authorization_path}\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_device_verification_path}\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_health_check_path}\"/>\n                            <L7p:Value stringValue=\"1\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_backchannel_authentication_path}\"/>\n                            <L7p:Value stringValue=\"10\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_par_authorization_path}\"/>\n                            <L7p:Value stringValue=\"100\"/>\n                        </L7p:item>\n                    </L7p:Mappings>\n                    <L7p:OutputVar stringValue=\"requests_per_second\"/>\n                </L7p:MapValue>\n                <L7p:MapValue>\n                    <L7p:InputExpr stringValue=\"${request.url.path}\"/>\n                    <L7p:Mappings nameValuePairArray=\"included\">\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager/clients\"/>\n                            <L7p:Value stringValue=\"oauth/manager/clients-${current.username}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager/tokens\"/>\n                            <L7p:Value stringValue=\"oauth/manager/tokens-${current.username}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"oauth/manager\"/>\n                            <L7p:Value stringValue=\"oauth/manager-${current.username}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_token_revocation_list_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_token_revocation_list_path}-${access_token}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_token_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_token_path}-${client_id}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"auth/oauth/v2/client/export\"/>\n                            <L7p:Value stringValue=\"auth/oauth/v2/client/export-${current.username}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${userinfo_path}\"/>\n                            <L7p:Value stringValue=\"${userinfo_path}-${access_token}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_device_authorization_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_device_authorization_path}-${client_id}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_device_verification_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_device_verification_path}-${current.username}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_health_check_path}\"/>\n                            <L7p:Value stringValue=\"${request.http.parameter.apikey}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_backchannel_authentication_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_backchannel_authentication_path}-${client_id}\"/>\n                        </L7p:item>\n                        <L7p:item nameValuePair=\"included\">\n                            <L7p:Key stringValue=\"${oauth2_par_authorization_path}\"/>\n                            <L7p:Value stringValue=\"${oauth2_par_authorization_path}-${client_id}\"/>\n                        </L7p:item>\n                    </L7p:Mappings>\n                    <L7p:OutputVar stringValue=\"custom_limit_key\"/>\n                </L7p:MapValue>\n                <L7p:RateLimit>\n                    <L7p:CounterName stringValue=\"${custom_limit_key}\"/>\n                    <L7p:MaxRequestsPerSecond stringValue=\"${requests_per_second}\"/>\n                </L7p:RateLimit>\n            </wsp:All>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <L7p:Encapsulated>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"111\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"apiPrefix\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"givenErrorCode\"/>\n                            <L7p:value stringValue=\"111\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:SetVariable>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"== OVERRIDE\"/>\n                                </L7p:entry>\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// This is here in case the gateway has both MAG and OTK installed, because MAG also has error code 111 and that results in different error.msg\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:Base64Expression stringValue=\"ew0KICAiZXJyb3IiOiJpbnZhbGlkX3JlcXVlc3QiLA0KICAiZXJyb3JfZGVzY3JpcHRpb24iOiJUaGUgc2VydmljZSBpcyB0ZW1wb3JhcmlseSBub3QgYXZhaWxhYmxlIg0KfQ==\"/>\n                        <L7p:VariableToSet stringValue=\"error.msg\"/>\n                    </L7p:SetVariable>\n                    <L7p:FalseAssertion/>\n                </wsp:All>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// error\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n        </wsp:OneOrMore>\n    </wsp:All>\n</wsp:Policy>"
  }
}