{
  "goid": "d2fa9e7e0db9f0c56c13fe57e46309e1",
  "guid": "03d4ea7a-8557-4002-80b2-925e52eb4e26",
  "name": "#OTK Validate JWT OAuth Token",
  "policyType": "FRAGMENT",
  "checksum": "fb9ad4225f4df6222a0726f8a10ef162480e99bd",
  "folderPath": "/OTK/Customizations",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Policy Fragment: #OTK Validate JWT OAuth Token\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Private key to decode JWT can be modified in the below assertion.\"/>\n        </L7p:CommentAssertion>\n        <L7p:DecodeJsonWebToken>\n            <L7p:FailUnverifiedSignature booleanValue=\"true\"/>\n            <L7p:KeyAlias stringValue=\"ssl\"/>\n            <L7p:KeyGoid goidValue=\"00000000000000000000000000000002\"/>\n            <L7p:SourcePayload stringValue=\"${access_token}\"/>\n            <L7p:TargetVariablePrefix stringValue=\"jwt\"/>\n            <L7p:ValidationType stringValue=\"Using Recipient Key From List\"/>\n        </L7p:DecodeJsonWebToken>\n        <L7p:SetVariable>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"convert payload to json, to extract values in the next steps\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Base64Expression stringValue=\"JHtqd3QucGF5bG9hZH0=\"/>\n            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"payload_json\"/>\n        </L7p:SetVariable>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract JTI which is also the access_token\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"jti\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"jti\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract hte issuer (iss)\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"iss\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"iss\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract the audience (aud)\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"aud\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"aud\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract expiration (exp)\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"exp\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"exp\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract the SCOPE that was granted for this token\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"token_details.scope\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"scope\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <L7p:EvaluateJsonPathExpressionV2>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// extract the Client_key associated with the token\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Expression stringValue=\"token_details.client_key\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:VariablePrefix stringValue=\"client_key\"/>\n        </L7p:EvaluateJsonPathExpressionV2>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:EvaluateJsonPathExpressionV2>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// extract the resource owner if it exists\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Expression stringValue=\"token_details.preferred_username\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"payload_json\"/>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:VariablePrefix stringValue=\"owner\"/>\n            </L7p:EvaluateJsonPathExpressionV2>\n            <L7p:SetVariable>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"set variable to unknown if owner not part of payload\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Base64Expression stringValue=\"dW5rbm93bg==\"/>\n                <L7p:VariableToSet stringValue=\"owner.result\"/>\n            </L7p:SetVariable>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// Sets owner \"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// Set resp with extracted values, used for validation later\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Base64Expression stringValue=\"PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjx2YWx1ZXMgeG1sbnM9Imh0dHA6Ly9ucy5sN3RlY2guY29tLzIwMTIvMTEvb3RrLXRva2Vuc3RvcmUiIG9mZnNldD0iMSI+DQoJPHZhbHVlIGluZGV4PSIxIj4NCgkJPHRva2VuPjwhW0NEQVRBWyR7anRpLnJlc3VsdH1dXT48L3Rva2VuPg0KCQk8c2VjcmV0Lz4NCgkJPGV4cGlyYXRpb24+PCFbQ0RBVEFbJHtleHAucmVzdWx0fV1dPjwvZXhwaXJhdGlvbj4NCgkJPHJ0b2tlbj48L3J0b2tlbj4NCgkJPHJleHBpcmF0aW9uPjwvcmV4cGlyYXRpb24+DQoJCTxzY29wZT48IVtDREFUQVske3Njb3BlLnJlc3VsdH1dXT48L3Njb3BlPg0KCQk8cmVzb3VyY2U+PCFbQ0RBVEFbJHthdWQucmVzdWx0c3wgfV1dPjwvcmVzb3VyY2U+DQoJCTxyZXNvdXJjZV9vd25lcj48IVtDREFUQVske293bmVyLnJlc3VsdH1dXT48L3Jlc291cmNlX293bmVyPg0KCQk8Y2xpZW50X2tleT48IVtDREFUQVske2NsaWVudF9rZXkucmVzdWx0fV1dPjwvY2xpZW50X2tleT4NCgkJPGNsaWVudF9uYW1lPjwvY2xpZW50X25hbWU+IA0KCQk8c3RhdHVzPkVOQUJMRUQ8L3N0YXR1cz4NCgkJPGNyZWF0ZWQ+PC9jcmVhdGVkPg0KCQk8Y3VzdG9tPjwhW0NEQVRBWyR7and0LnBheWxvYWR9XV0+PC9jdXN0b20+DQoJPC92YWx1ZT4NCjwvdmFsdWVzPg==\"/>\n            <L7p:ContentType stringValue=\"text/xml; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"resp\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtnYXRld2F5Lm90ay5hY2Nlc3NfdG9rZW4uZW5hYmxlX2p3dC5xdWVyeV9kYn0=\"/>\n            <L7p:VariableToSet stringValue=\"query_db\"/>\n        </L7p:SetVariable>\n    </wsp:All>\n</wsp:Policy>"
  }
}