{
  "goid": "e04ad90cfcec38e51fbe3ed9fe092b3f",
  "guid": "fdcbc885-1318-48e1-af48-0c2f1b6e9795",
  "name": "OTK grant_type=CUSTOM",
  "policyType": "FRAGMENT",
  "checksum": "d8189018e44b70ffcd7f332700ab924374477997",
  "folderPath": "/OTK/Customizations/grant_types",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== Target policy:  /auth/oauth/v2/token\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== this policy can be used to implement custom grant types\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== output:  clientResponse, json structure containing issued token to client\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== See the policy:  #OTK Configured Grant Types\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== Below is an example implementation.  \"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${grant_type}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"string\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:RightValue stringValue=\"grantTypeCustom1\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== validate incoming parameters according to grant_type\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== append expiration to token when partition key is enabled and refresh token is not used in the grant\"/>\n                </L7p:CommentAssertion>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${dbsystem}\"/>\n                        <L7p:ExpressionIsVariable booleanValue=\"false\"/>\n                        <L7p:Operator operatorNull=\"null\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item dataType=\"included\">\n                                <L7p:Type variableDataType=\"string\"/>\n                            </L7p:item>\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:Negated booleanValue=\"true\"/>\n                                <L7p:RightValue stringValue=\"oracle\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${gateway.otk.token_include_partition_key}\"/>\n                        <L7p:ExpressionIsVariable booleanValue=\"false\"/>\n                        <L7p:Operator operatorNull=\"null\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item dataType=\"included\">\n                                <L7p:Type variableDataType=\"boolean\"/>\n                            </L7p:item>\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"false\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHthdF9leHBpcmF0aW9ufQ==\"/>\n                            <L7p:VariableToSet stringValue=\"epochSeconds\"/>\n                        </L7p:SetVariable>\n                        <L7p:JavaScript>\n                            <L7p:ExecutionTimeout stringValue=\"\"/>\n                            <L7p:Name stringValue=\"\"/>\n                            <L7p:Script stringValueReference=\"inline\"><![CDATA[var epoch = context.getVariable(\"epochSeconds\")\nvar partition_interval = context.getVariable(\"gateway.otk.oracle.partition_interval\")\nvar exp_interval = Math.round(epoch/(partition_interval*60))\ncontext.setVariable(\"exp_interval\", exp_interval);]]></L7p:Script>\n                        </L7p:JavaScript>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHthdF90b2tlbn0tJHtleHBfaW50ZXJ2YWx9\"/>\n                            <L7p:VariableToSet stringValue=\"at_token\"/>\n                        </L7p:SetVariable>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// append expiration as token suffix if refresh token is not used in this grant\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== use OTK Token Persist* to persist token\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== configure clientResponse (below)\"/>\n                </L7p:CommentAssertion>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"ew0KICAiZ3JhbnRfdHlwZSI6ICIke2dyYW50X3R5cGV9IiwNCiAgImFjY2Vzc190b2tlbiI6IiR7YXRfdG9rZW59IiwNCiAgInRva2VuX3R5cGUiOiJCZWFyZXIiLA0KICAiZXhwaXJlc19pbiI6JHthdF9saWZldGltZX0sDQogICJyZWZyZXNoX3Rva2VuIjoiJHtydG9rZW59IiwNCiAgInNjb3BlIjoiJHtzY29wZS5ncmFudGVkfSINCn0=\"/>\n                    <L7p:VariableToSet stringValue=\"clientResponse\"/>\n                </L7p:SetVariable>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${grant_type}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"string\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:RightValue stringValue=\"grantTypeCustom2\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== validate incoming parameters according to grant_type\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== append rexpiration to token when partition key is enabled and refresh token is  used in the grant\"/>\n                </L7p:CommentAssertion>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${dbsystem}\"/>\n                        <L7p:ExpressionIsVariable booleanValue=\"false\"/>\n                        <L7p:Operator operatorNull=\"null\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item dataType=\"included\">\n                                <L7p:Type variableDataType=\"string\"/>\n                            </L7p:item>\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:Negated booleanValue=\"true\"/>\n                                <L7p:RightValue stringValue=\"oracle\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${gateway.otk.token_include_partition_key}\"/>\n                        <L7p:ExpressionIsVariable booleanValue=\"false\"/>\n                        <L7p:Operator operatorNull=\"null\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item dataType=\"included\">\n                                <L7p:Type variableDataType=\"boolean\"/>\n                            </L7p:item>\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"false\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHtyZXhwaXJhdGlvbn0=\"/>\n                            <L7p:VariableToSet stringValue=\"epochSeconds\"/>\n                        </L7p:SetVariable>\n                        <L7p:JavaScript>\n                            <L7p:ExecutionTimeout stringValue=\"\"/>\n                            <L7p:Name stringValue=\"\"/>\n                            <L7p:Script stringValueReference=\"inline\"><![CDATA[var epoch = context.getVariable(\"epochSeconds\")\nvar partition_interval = context.getVariable(\"gateway.otk.oracle.partition_interval\")\nvar exp_interval = Math.round(epoch/(partition_interval*60))\ncontext.setVariable(\"exp_interval\", exp_interval);]]></L7p:Script>\n                        </L7p:JavaScript>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHthdF90b2tlbn0tJHtleHBfaW50ZXJ2YWx9\"/>\n                            <L7p:VariableToSet stringValue=\"at_token\"/>\n                        </L7p:SetVariable>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// append rexpiration as token suffix if refresh token is  used in this grant\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== use OTK Token Persist* to persist token\"/>\n                </L7p:CommentAssertion>\n                <L7p:CommentAssertion>\n                    <L7p:Comment stringValue=\"== configure clientResponse (below)\"/>\n                </L7p:CommentAssertion>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"ew0KICAiZ3JhbnRfdHlwZSI6ICIke2dyYW50X3R5cGV9IiwNCiAgImFjY2Vzc190b2tlbiI6IiR7YXRfdG9rZW59IiwNCiAgInRva2VuX3R5cGUiOiJCZWFyZXIiLA0KICAiZXhwaXJlc19pbiI6JHthdF9saWZldGltZX0sDQogICJyZWZyZXNoX3Rva2VuIjoiJHtydG9rZW59IiwNCiAgInNjb3BlIjoiJHtzY29wZS5ncmFudGVkfSINCn0=\"/>\n                    <L7p:VariableToSet stringValue=\"clientResponse\"/>\n                </L7p:SetVariable>\n            </wsp:All>\n        </wsp:OneOrMore>\n    </wsp:All>\n</wsp:Policy>"
  }
}