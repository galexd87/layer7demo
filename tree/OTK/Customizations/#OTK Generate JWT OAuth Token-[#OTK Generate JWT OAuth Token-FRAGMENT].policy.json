{
  "goid": "cdd667c3870313491b3166e02cfd9708",
  "guid": "fe475474-1138-4e2f-895b-885cc49748f4",
  "name": "#OTK Generate JWT OAuth Token",
  "policyType": "FRAGMENT",
  "checksum": "f13144440d21dff78f686d0e11e61f54f3511919",
  "folderPath": "/OTK/Customizations",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Policy Fragment: #OTK Generate JWT OAuth Token\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Target policy: OTK Generate JWT OAuth Token\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Enable the below assertions to generate JWT based access_token\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Variable 'custom' includes session information and preferred user\"/>\n        </L7p:CommentAssertion>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"\"/>\n            <L7p:DataType variableDataType=\"dateTime\"/>\n            <L7p:DateFormat stringValue=\"&lt;Second Timestamp>\"/>\n            <L7p:DateOffsetExpression stringValue=\"${lifetime}\"/>\n            <L7p:VariableToSet stringValue=\"exp\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtleHAuc2Vjb25kc30=\"/>\n            <L7p:VariableToSet stringValue=\"at_jwt_exp\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtjdXN0b21fZGF0YX0=\"/>\n            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"custom_json\"/>\n        </L7p:SetVariable>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Below 'All Assertion' includes preferred user into the JWT payload if scope includes 'openid'\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${mTLS_certificate_thumbprint}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"bed74d70-cc8b-46b8-8efc-f5a8a995b2f3\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Encode base64url\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"base64_encoded\"/>\n                            <L7p:value stringValue=\"${mTLS_certificate_thumbprint}\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n                <L7p:SetVariable>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// add confirmation member as certificate thumbprint \"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:Base64Expression stringValue=\"ImNuZiI6IHsNCiAgIng1dCNTMjU2IjogIiR7YmFzZTY0dXJsX2VuY29kZWR9Ig0KfSw=\"/>\n                    <L7p:VariableToSet stringValue=\"cnf\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"add cnf if cert thumbprint is not emtpy\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:SetVariable>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"//default\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Base64Expression stringValue=\"\"/>\n                <L7p:VariableToSet stringValue=\"cnf\"/>\n            </L7p:SetVariable>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// Set jwt cnf value\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:All wsp:Usage=\"Required\">\n            <L7p:Split>\n                <L7p:IgnoreEmptyValues booleanValue=\"true\"/>\n                <L7p:InputVariable stringValue=\"resource\"/>\n                <L7p:OutputVariable stringValue=\"resource.tokens\"/>\n                <L7p:SplitPattern stringValue=\" \"/>\n            </L7p:Split>\n            <L7p:Join>\n                <L7p:InputVariable stringValue=\"resource.tokens\"/>\n                <L7p:JoinSubstring stringValue=\"&quot;, &quot;\"/>\n                <L7p:OutputVariable stringValue=\"resource.temp\"/>\n            </L7p:Join>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"WyIke3Jlc291cmNlLnRlbXB9Il0=\"/>\n                <L7p:VariableToSet stringValue=\"resource.array\"/>\n            </L7p:SetVariable>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"Audience array\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:All>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:Expression1 stringValue=\"${act}\"/>\n                <L7p:Expression2 stringValue=\"\"/>\n                <L7p:Operator operator=\"EMPTY\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:RightValue stringValue=\"\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"ImFjdCI6IHske2FjdH19LA==\"/>\n                <L7p:VariableToSet stringValue=\"act\"/>\n            </L7p:SetVariable>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// act claim\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:CommentAssertion>\n                <L7p:Comment stringValue=\"Disable the 'All Assertion' below if preferred user need not be included in payload\"/>\n            </L7p:CommentAssertion>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${scope}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${custom_json.mainpart}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Regex>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:CaseInsensitive booleanValue=\"true\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"scope\"/>\n                    <L7p:Regex stringValue=\"openid\"/>\n                    <L7p:RegexName stringValue=\"Proceed if openid in scope\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// Extract preferred owner\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:Expression stringValue=\"username\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"custom_json\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"owner\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"ew0KICAiaXNzIjogIiR7aXNzfSIsDQogICJpYXQiOiR7Z2F0ZXdheS50aW1lLnNlY29uZHN9LA0KICAiYXVkIjoke3Jlc291cmNlLmFycmF5fSwNCiAgImV4cCI6JHthdF9qd3RfZXhwfSwNCiAgImp0aSI6IiR7anRpfSIsDQogICR7Y25mfQ0KICAke2FjdH0NCiAgImNsaWVudF9pZCI6ICIke2F1ZH0iLA0KICAic2NvcGUiOiIke3Njb3BlfSIsDQogICJ0b2tlbl9kZXRhaWxzIjogew0KICAgICJzY29wZSI6IiR7c2NvcGV9IiwNCiAgICAiZXhwaXJlc19pbiI6JHtsaWZldGltZX0sDQogICAgInRva2VuX3R5cGUiOiJCZWFyZXIiLA0KICAgICJwcmVmZXJyZWRfdXNlcm5hbWUiOiIke293bmVyLnJlc3VsdH0iLA0KICAgICJjbGllbnRfa2V5IjogIiR7YXVkfSINCiAgfQ0KfQ==\"/>\n                    <L7p:VariableToSet stringValue=\"payload\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// payload will include preferred_owner in this branch\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"ew0KICAiaXNzIjogIiR7aXNzfSIsDQogICJpYXQiOiR7Z2F0ZXdheS50aW1lLnNlY29uZHN9LA0KICAiYXVkIjoke3Jlc291cmNlLmFycmF5fSwNCiAgImV4cCI6JHthdF9qd3RfZXhwfSwNCiAgImp0aSI6IiR7anRpfSIsDQogICR7Y25mfQ0KICAke2FjdH0NCiAgImNsaWVudF9pZCI6ICIke2F1ZH0iLA0KICAic2NvcGUiOiIke3Njb3BlfSIsDQogICJ0b2tlbl9kZXRhaWxzIjogew0KICAgICJzY29wZSI6IiR7c2NvcGV9IiwNCiAgICAiZXhwaXJlc19pbiI6JHtsaWZldGltZX0sDQogICAgInRva2VuX3R5cGUiOiJCZWFyZXIiLA0KICAgICJjbGllbnRfa2V5IjogIiR7YXVkfSINCiAgfQ0KfQ==\"/>\n                <L7p:VariableToSet stringValue=\"payload\"/>\n            </L7p:SetVariable>\n        </wsp:OneOrMore>\n        <L7p:EncodeJsonWebToken>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// add header 'kid'\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:EncryptionSourceType intValue=\"2\"/>\n            <L7p:HeaderAction stringValue=\"Merge to Generated Header\"/>\n            <L7p:KeyAlias stringValue=\"ssl\"/>\n            <L7p:KeyGoid goidValue=\"00000000000000000000000000000002\"/>\n            <L7p:SignPayload booleanValue=\"true\"/>\n            <L7p:SignatureAlgorithm stringValue=\"RS256\"/>\n            <L7p:SignatureSourceType intValue=\"1\"/>\n            <L7p:SourceHeaders stringValue=\"${kid_header}\"/>\n            <L7p:SourceVariable stringValue=\"${payload}\"/>\n            <L7p:TargetVariable stringValue=\"at_jwt\"/>\n        </L7p:EncodeJsonWebToken>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHthdF9qd3QuY29tcGFjdH0=\"/>\n            <L7p:VariableToSet stringValue=\"at_jwt\"/>\n        </L7p:SetVariable>\n    </wsp:All>\n</wsp:Policy>"
  }
}