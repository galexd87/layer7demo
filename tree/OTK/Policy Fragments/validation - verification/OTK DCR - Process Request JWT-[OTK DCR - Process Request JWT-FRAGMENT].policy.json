{
  "goid": "2ab3dd0e21ff9887303b082fa5fd9788",
  "guid": "3d47d14e-c4d2-4d07-bb14-3f495a0d1dcf",
  "name": "OTK DCR - Process Request JWT",
  "policyType": "FRAGMENT",
  "checksum": "6b0cfa997d2a40cb21ab4c3efaa1149828b976ef",
  "folderPath": "/OTK/Policy Fragments/validation - verification",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"6d78c656-3d23-40af-b583-0115ae7dd284\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Get Client Certificate from Request\"/>\n        </L7p:Encapsulated>\n        <L7p:Encapsulated>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate tpp mTLS cert partially\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"ccd8081b-3a09-49e1-bcf8-179067a34793\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK DCR - Validate mTLS Certificate\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"mtls_cert_base64\"/>\n                    <L7p:value stringValue=\"${client_cert_base64}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"ssa\"/>\n                    <L7p:value stringValue=\"\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"72449a64-b6a3-4c06-aeec-686cd2d071a5\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Software Statement Configuration\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"custom\"/>\n                    <L7p:value stringValue=\"\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"----  START: Validate SSA signature ----\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"3a383b6b-f60d-4d1b-a08d-26ea81c539a7\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Inspect JWT\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwks\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwt\"/>\n                        <L7p:value stringValue=\"${request.mainpart}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"kid\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"315\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ dcr jwt, decode only\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"jwt_payload\"/>\n        </L7p:SetVariable>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:EvaluateJsonPathExpressionV2>\n                <L7p:Expression stringValue=\"$.software_statement\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload\"/>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:VariablePrefix stringValue=\"ssa_path\"/>\n            </L7p:EvaluateJsonPathExpressionV2>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"320\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ extract ssa\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"70c75780-8758-4450-8d96-506441369e07\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Get JWKS\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"cache_lifetime\"/>\n                        <L7p:value stringValue=\"3600\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwks_url\"/>\n                        <L7p:value stringValue=\"${gateway.otk.open_banking_directory.jwks_url}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:Expression1 stringValue=\"${error.code}\"/>\n                        <L7p:Expression2 stringValue=\"\"/>\n                        <L7p:Negate booleanValue=\"true\"/>\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:Negated booleanValue=\"true\"/>\n                                <L7p:Operator operator=\"EMPTY\"/>\n                                <L7p:RightValue stringValue=\"\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:Encapsulated>\n                        <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                        <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                        <L7p:Parameters mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"apiPrefix\"/>\n                                <L7p:value stringValue=\"\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"custom\"/>\n                                <L7p:value stringValue=\"\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"givenErrorCode\"/>\n                                <L7p:value stringValue=\"${error.code}\"/>\n                            </L7p:entry>\n                        </L7p:Parameters>\n                    </L7p:Encapsulated>\n                </wsp:All>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"error\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"321\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~  obd jwks\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:DecodeJsonWebToken>\n                    <L7p:DetachedJwsContent stringValue=\"\"/>\n                    <L7p:SourcePayload stringValue=\"${ssa_path.result}\"/>\n                    <L7p:TargetVariablePrefix stringValue=\"jwt_payload\"/>\n                    <L7p:ValidationType stringValue=\"None\"/>\n                </L7p:DecodeJsonWebToken>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZC5oZWFkZXJ9\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload.header\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.kid\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload.header\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"ssa_kid\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n            </wsp:All>\n            <L7p:TrueAssertion/>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ get kid\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"3a383b6b-f60d-4d1b-a08d-26ea81c539a7\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Inspect JWT\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwks\"/>\n                        <L7p:value stringValue=\"${jwks}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwt\"/>\n                        <L7p:value stringValue=\"${ssa_path.result}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"kid\"/>\n                        <L7p:value stringValue=\"${ssa_kid.result}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"320\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ ssa jwt, decode and validate\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload_temp\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.exp\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload_temp\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"ssa_exp\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtzc2FfZXhwLnJlc3VsdH0=\"/>\n                    <L7p:DataType variableDataType=\"int\"/>\n                    <L7p:VariableToSet stringValue=\"ssa_exp\"/>\n                </L7p:SetVariable>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${ssa_exp}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"int\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"GE\"/>\n                            <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n            </wsp:All>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"322\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate expiry\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"\"/>\n                    <L7p:VariableToSet stringValue=\"ssa_nbf\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload_temp\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.nbf\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload_temp\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"ssa_nbf\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtzc2FfbmJmLnJlc3VsdH0=\"/>\n                    <L7p:DataType variableDataType=\"int\"/>\n                    <L7p:VariableToSet stringValue=\"ssa_nbf\"/>\n                </L7p:SetVariable>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${ssa_nbf}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"int\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"LE\"/>\n                            <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n            </wsp:All>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${ssa_nbf}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"apiPrefix\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"custom\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"givenErrorCode\"/>\n                            <L7p:value stringValue=\"191\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n            </wsp:OneOrMore>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate nbf\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n            <L7p:VariableToSet stringValue=\"ssa_payload\"/>\n        </L7p:SetVariable>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"----  END: Validate SSA signature ----\"/>\n        </L7p:CommentAssertion>\n        <L7p:Encapsulated>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate tpp mTLS cert using software_statement\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"ccd8081b-3a09-49e1-bcf8-179067a34793\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK DCR - Validate mTLS Certificate\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"mtls_cert_base64\"/>\n                    <L7p:value stringValue=\"${client_cert_base64}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"software_id_json_path\"/>\n                    <L7p:value stringValue=\"${software_id_json_path}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"ssa\"/>\n                    <L7p:value stringValue=\"${ssa_payload}\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"----  START: Validate DCR request signature ----\"/>\n        </L7p:CommentAssertion>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtzc2FfcGF5bG9hZH0=\"/>\n            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"ssa_message\"/>\n        </L7p:SetVariable>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:EvaluateJsonPathExpressionV2>\n                <L7p:Expression stringValue=\"${software_jwks_endpoint_json_path}\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"ssa_message\"/>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:VariablePrefix stringValue=\"tpp_jwks_url_path\"/>\n            </L7p:EvaluateJsonPathExpressionV2>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"320\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ extract ssa jwks endpoint\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"~ tpp jwks\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"70c75780-8758-4450-8d96-506441369e07\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Get JWKS\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"cache_lifetime\"/>\n                        <L7p:value stringValue=\"3600\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwks_url\"/>\n                        <L7p:value stringValue=\"${tpp_jwks_url_path.result}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:Expression1 stringValue=\"${error.code}\"/>\n                        <L7p:Expression2 stringValue=\"\"/>\n                        <L7p:Negate booleanValue=\"true\"/>\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:Negated booleanValue=\"true\"/>\n                                <L7p:Operator operator=\"EMPTY\"/>\n                                <L7p:RightValue stringValue=\"\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:Encapsulated>\n                        <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                        <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                        <L7p:Parameters mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"apiPrefix\"/>\n                                <L7p:value stringValue=\"\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"custom\"/>\n                                <L7p:value stringValue=\"\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"givenErrorCode\"/>\n                                <L7p:value stringValue=\"${error.code}\"/>\n                            </L7p:entry>\n                        </L7p:Parameters>\n                    </L7p:Encapsulated>\n                </wsp:All>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"error\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"306\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ client jwks\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:DecodeJsonWebToken>\n                    <L7p:DetachedJwsContent stringValue=\"\"/>\n                    <L7p:SourcePayload stringValue=\"${request.mainpart}\"/>\n                    <L7p:TargetVariablePrefix stringValue=\"jwt_payload\"/>\n                    <L7p:ValidationType stringValue=\"None\"/>\n                </L7p:DecodeJsonWebToken>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZC5oZWFkZXJ9\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload.header\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.kid\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload.header\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"dcr_kid\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n            </wsp:All>\n            <L7p:TrueAssertion/>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ get kid\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"3a383b6b-f60d-4d1b-a08d-26ea81c539a7\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Inspect JWT\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwks\"/>\n                        <L7p:value stringValue=\"${jwks}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwt\"/>\n                        <L7p:value stringValue=\"${request.mainpart}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"kid\"/>\n                        <L7p:value stringValue=\"${dcr_kid.result}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"315\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ dcr jwt, decode and validate\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload_temp\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.exp\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload_temp\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"ssa_exp\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtzc2FfZXhwLnJlc3VsdH0=\"/>\n                    <L7p:DataType variableDataType=\"int\"/>\n                    <L7p:VariableToSet stringValue=\"dcr_exp\"/>\n                </L7p:SetVariable>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${dcr_exp}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"int\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"GE\"/>\n                            <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n            </wsp:All>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"apiPrefix\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"custom\"/>\n                        <L7p:value stringValue=\"\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"givenErrorCode\"/>\n                        <L7p:value stringValue=\"323\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate expiry\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"\"/>\n                    <L7p:VariableToSet stringValue=\"dcr_nbf\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_payload_temp\"/>\n                </L7p:SetVariable>\n                <L7p:EvaluateJsonPathExpressionV2>\n                    <L7p:Expression stringValue=\"$.nbf\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"jwt_payload_temp\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:VariablePrefix stringValue=\"dcr_nbf\"/>\n                </L7p:EvaluateJsonPathExpressionV2>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtkY3JfbmJmLnJlc3VsdH0=\"/>\n                    <L7p:DataType variableDataType=\"int\"/>\n                    <L7p:VariableToSet stringValue=\"dcr_nbf\"/>\n                </L7p:SetVariable>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${dcr_nbf}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"int\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"LE\"/>\n                            <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n            </wsp:All>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${dcr_nbf}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"56bd8147-3ab4-4d09-9460-8b2de02b7a9e\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Fail with error message\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"apiPrefix\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"custom\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"givenErrorCode\"/>\n                            <L7p:value stringValue=\"191\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n            </wsp:OneOrMore>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ validate nbf\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtqd3RfcGF5bG9hZH0=\"/>\n            <L7p:VariableToSet stringValue=\"dcr_payload\"/>\n        </L7p:SetVariable>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"----  END: Validate DCR request signature ----\"/>\n        </L7p:CommentAssertion>\n        <L7p:Encapsulated>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"~ compose DCR using dcr_payload and ssa_payload\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"9c46e6e7-87c6-4949-b2a3-b16a76bf886e\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK DCR - Compose Request\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"dcr_payload\"/>\n                    <L7p:value stringValue=\"${dcr_payload}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"ssa_payload\"/>\n                    <L7p:value stringValue=\"${ssa_payload}\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n    </wsp:All>\n</wsp:Policy>"
  }
}