{
  "goid": "b8fff8ea029f0cb76d0774923de472df",
  "guid": "24e6e800-5353-4204-b73f-aa9715bd98bc",
  "name": "OTK Client JWT Validation",
  "policyType": "FRAGMENT",
  "checksum": "836364f077a36602d4b4a802cea9d2b05df475fb",
  "folderPath": "/OTK/Policy Fragments/validation - verification",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === ***  THIS POLICY IS READ ONLY ***\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === If you have the need to customize this policy\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === please contact CA APIM Support so we can improve customization capability\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"This policy can be found and should be used as 'Encapsulated Assertion'!\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Client JWT is validated using auth method, alg used during client registration, after which its payload content is verified\"/>\n        </L7p:CommentAssertion>\n        <L7p:SetVariable>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// create json to extract values afterwards\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Base64Expression stringValue=\"JHtjbGllbnRfa2V5X2N1c3RvbX0=\"/>\n            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"custom_json\"/>\n        </L7p:SetVariable>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"2e6e2ef3-a36f-4548-a2c4-7b369b7ae184\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Variable Configuration\"/>\n        </L7p:Encapsulated>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"355ca731-f92a-4d64-b41a-8533eedfa651\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Profile Configuration\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"client_id\"/>\n                    <L7p:value stringValue=\"${client_id}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"client_key_custom\"/>\n                    <L7p:value stringValue=\"${client_key_custom}\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>        \n        <wsp:All wsp:Usage=\"Required\">\n            <L7p:EvaluateJsonPathExpressionV2>\n                <L7p:Expression stringValue=\"openid_registration.response.token_endpoint_auth_method\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"custom_json\"/>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:VariablePrefix stringValue=\"auth_method\"/>\n            </L7p:EvaluateJsonPathExpressionV2>\n            <L7p:EvaluateJsonPathExpressionV2>\n                <L7p:Expression stringValue=\"openid_registration.response.token_endpoint_auth_signing_alg\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"custom_json\"/>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:VariablePrefix stringValue=\"auth_signing_alg\"/>\n            </L7p:EvaluateJsonPathExpressionV2>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"JHthdXRoX21ldGhvZC5yZXN1bHR9\"/>\n                <L7p:VariableToSet stringValue=\"client_auth_method\"/>\n            </L7p:SetVariable>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"JHthdXRoX3NpZ25pbmdfYWxnLnJlc3VsdH0=\"/>\n                <L7p:VariableToSet stringValue=\"client_auth_signing_alg\"/>\n            </L7p:SetVariable>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"\"/>\n                <L7p:VariableToSet stringValue=\"client_jwks\"/>\n            </L7p:SetVariable>\n            <L7p:SetVariable>\n                <L7p:Base64Expression stringValue=\"\"/>\n                <L7p:VariableToSet stringValue=\"client_jwks_uri\"/>\n            </L7p:SetVariable>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${client_auth_method}\"/>\n                    <L7p:Expression2 stringValue=\"private_key_jwt\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:RightValue stringValue=\"private_key_jwt\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:JSONSchema>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Validation\"/>\n                                </L7p:entry>\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Check if secret is a JSON object\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:JsonSchemaVersion jsonSchemaVersion=\"DRAFT_V4\"/>\n                        <L7p:OtherTargetMessageVariable stringValue=\"client_secret\"/>\n                        <L7p:ResourceInfo staticResourceInfo=\"included\">\n                            <L7p:Document stringValueReference=\"inline\"><![CDATA[{\n                \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n                \"title\": \"Client Registration Message Validation\",\n                \"description\": \"Verify that input is a JSON message\",\n                \"type\": \"object\"\n                }]]></L7p:Document>\n                        </L7p:ResourceInfo>\n                        <L7p:Target target=\"OTHER\"/>\n                    </L7p:JSONSchema>\n                    <L7p:Regex>\n                        <L7p:AutoTarget booleanValue=\"false\"/>\n                        <L7p:OtherTargetMessageVariable stringValue=\"client_secret\"/>\n                        <L7p:ProceedIfPatternMatches booleanValue=\"false\"/>\n                        <L7p:Regex stringValue=\"[&lt;>]|\\\\&quot;\"/>\n                        <L7p:Replacement stringValue=\"\"/>\n                        <L7p:Target target=\"OTHER\"/>\n                    </L7p:Regex>\n                    <L7p:SetVariable>\n                        <L7p:Base64Expression stringValue=\"JHtjbGllbnRfc2VjcmV0fQ==\"/>\n                        <L7p:VariableToSet stringValue=\"client_jwks\"/>\n                    </L7p:SetVariable>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"jwks\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// client_secret contains a jwk\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:All>\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:SetVariable>\n                        <L7p:Base64Expression stringValue=\"JHtjbGllbnRfc2VjcmV0fQ==\"/>\n                        <L7p:VariableToSet stringValue=\"client_jwks_uri\"/>\n                    </L7p:SetVariable>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"jwks_uri\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// client_secret contains a jwks_uri\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:All>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// set jwks/jwks_uri from secret if needed\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// Extract variables from client_key_custom\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:All>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${client_auth_method}\"/>\n                    <L7p:Expression2 stringValue=\"client_secret_jwt\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"client_secret_jwt\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${client_secret}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:DecodeJsonWebToken>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// validate jwt signature using client_secret, fails if invalid\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:FailUnverifiedSignature booleanValue=\"true\"/>\n                    <L7p:SignatureSecret stringValue=\"${client_secret}\"/>\n                    <L7p:SourcePayload stringValue=\"${client_assertion}\"/>\n                    <L7p:TargetVariablePrefix stringValue=\"client_jwt\"/>\n                    <L7p:ValidationType stringValue=\"Using Secret\"/>\n                </L7p:DecodeJsonWebToken>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// auth_method = &quot;client_secret_jwt&quot;\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${client_auth_method}\"/>\n                    <L7p:Expression2 stringValue=\"private_key_jwt\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"private_key_jwt\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:DecodeJsonWebToken>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// just decode to get &quot;kid&quot;, no validation\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:SourcePayload stringValue=\"${client_assertion}\"/>\n                    <L7p:TargetVariablePrefix stringValue=\"decoded_jwt\"/>\n                    <L7p:ValidationType stringValue=\"None\"/>\n                </L7p:DecodeJsonWebToken>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtkZWNvZGVkX2p3dC5oZWFkZXIua2lkfQ==\"/>\n                    <L7p:VariableToSet stringValue=\"jwt_kid\"/>\n                </L7p:SetVariable>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${client_jwks}\"/>\n                            <L7p:Expression2 stringValue=\"\"/>\n                            <L7p:Negate booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:Negated booleanValue=\"true\"/>\n                                    <L7p:Operator operator=\"EMPTY\"/>\n                                    <L7p:RightValue stringValue=\"\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:DecodeJsonWebToken>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// validate jwt signature using jwks, fails if invalid\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:FailUnverifiedSignature booleanValue=\"true\"/>\n                            <L7p:KeyId stringValue=\"${jwt_kid}\"/>\n                            <L7p:KeyType stringValue=\"JSON Web Key Set\"/>\n                            <L7p:PrivateKeySource stringValue=\"${client_jwks}\"/>\n                            <L7p:SourcePayload stringValue=\"${client_assertion}\"/>\n                            <L7p:TargetVariablePrefix stringValue=\"client_jwt\"/>\n                            <L7p:ValidationType stringValue=\"Using Recipient Key From Context Variable\"/>\n                        </L7p:DecodeJsonWebToken>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHtjbGllbnRfandrc30=\"/>\n                            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                            <L7p:DataType variableDataType=\"message\"/>\n                            <L7p:VariableToSet stringValue=\"jwks_json\"/>\n                        </L7p:SetVariable>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"jwks\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${client_jwks}\"/>\n                            <L7p:Expression2 stringValue=\"\"/>\n                            <L7p:Negate booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:Negated booleanValue=\"true\"/>\n                                    <L7p:Operator operator=\"EMPTY\"/>\n                                    <L7p:RightValue stringValue=\"\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <wsp:OneOrMore wsp:Usage=\"Required\">\n                            <wsp:All wsp:Usage=\"Required\">\n                                <L7p:SetVariable>\n                                    <L7p:Base64Expression stringValue=\"JHtjbGllbnRfandrc30=\"/>\n                                    <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                                    <L7p:DataType variableDataType=\"message\"/>\n                                    <L7p:VariableToSet stringValue=\"client_jwks_temp\"/>\n                                </L7p:SetVariable>\n                                <L7p:EvaluateJsonPathExpressionV2>\n                                    <L7p:Expression stringValue=\"keys[0]\"/>\n                                    <L7p:OtherTargetMessageVariable stringValue=\"client_jwks_temp\"/>\n                                    <L7p:Target target=\"OTHER\"/>\n                                    <L7p:VariablePrefix stringValue=\"client_jwks_json_path\"/>\n                                </L7p:EvaluateJsonPathExpressionV2>\n                                <L7p:SetVariable>\n                                    <L7p:Base64Expression stringValue=\"JHtjbGllbnRfandrc19qc29uX3BhdGgucmVzdWx0fQ==\"/>\n                                    <L7p:VariableToSet stringValue=\"client_jwks\"/>\n                                </L7p:SetVariable>\n                            </wsp:All>\n                            <L7p:TrueAssertion/>\n                            <L7p:assertionComment>\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// if single key os provided in a JWKS\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:assertionComment>\n                        </wsp:OneOrMore>\n                        <L7p:DecodeJsonWebToken>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// validate jwt signature using jwks, fails if invalid\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:DetachedJwsContent stringValue=\"\"/>\n                            <L7p:FailUnverifiedSignature booleanValue=\"true\"/>\n                            <L7p:KeyType stringValue=\"JSON Web Key\"/>\n                            <L7p:PrivateKeySource stringValue=\"${client_jwks}\"/>\n                            <L7p:SourcePayload stringValue=\"${client_assertion}\"/>\n                            <L7p:TargetVariablePrefix stringValue=\"client_jwt\"/>\n                            <L7p:ValidationType stringValue=\"Using Recipient Key From Context Variable\"/>\n                        </L7p:DecodeJsonWebToken>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"JHtjbGllbnRfandrc30=\"/>\n                            <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                            <L7p:DataType variableDataType=\"message\"/>\n                            <L7p:VariableToSet stringValue=\"jwks_json\"/>\n                        </L7p:SetVariable>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"jwk\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Expression1 stringValue=\"${client_jwks_uri}\"/>\n                            <L7p:Expression2 stringValue=\"\"/>\n                            <L7p:Negate booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                                    <L7p:Negated booleanValue=\"true\"/>\n                                    <L7p:Operator operator=\"EMPTY\"/>\n                                    <L7p:RightValue stringValue=\"\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:Include>\n                            <L7p:PolicyGuid stringValue=\"4c1beb3c-0300-443e-beb2-407cfc2bf6bb\"/>\n                            <L7p:PolicyName stringValue=\"#OTK Client JWT Validation\"/>\n                        </L7p:Include>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"jwks_uri\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// validate using jwks, jwk or jwks_uri\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:Expression1 stringValue=\"${oauth2_profile.fapi_advanced}\"/>\n                        <L7p:Expression2 stringValue=\"false\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:RightValue stringValue=\"false\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:EvaluateJsonPathExpressionV2>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// array of keys\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:Expression stringValue=\"keys\"/>\n                            <L7p:OtherTargetMessageVariable stringValue=\"jwks_json\"/>\n                            <L7p:Target target=\"OTHER\"/>\n                            <L7p:VariablePrefix stringValue=\"jwks_keys\"/>\n                        </L7p:EvaluateJsonPathExpressionV2>\n                        <L7p:ForEachLoop L7p:Usage=\"Required\" loopVariable=\"jwks_keys.results\" variablePrefix=\"jwks_key\">\n                            <wsp:OneOrMore wsp:Usage=\"Required\">\n                                <wsp:All wsp:Usage=\"Required\">\n                                    <L7p:SetVariable>\n                                        <L7p:Base64Expression stringValue=\"JHtqd2tzX2tleS5jdXJyZW50fQ==\"/>\n                                        <L7p:ContentType stringValue=\"application/json; charset=utf-8\"/>\n                                        <L7p:DataType variableDataType=\"message\"/>\n                                        <L7p:VariableToSet stringValue=\"jwks_key_json\"/>\n                                    </L7p:SetVariable>\n                                    <L7p:EvaluateJsonPathExpressionV2>\n                                        <L7p:AssertionComment assertionComment=\"included\">\n                                           <L7p:Properties mapValue=\"included\">\n                                           <L7p:entry>\n                                           <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                           <L7p:value stringValue=\"find kid\"/>\n                                           </L7p:entry>\n                                           </L7p:Properties>\n                                        </L7p:AssertionComment>\n                                        <L7p:Expression stringValue=\"kid\"/>\n                                        <L7p:OtherTargetMessageVariable stringValue=\"jwks_key_json\"/>\n                                        <L7p:Target target=\"OTHER\"/>\n                                        <L7p:VariablePrefix stringValue=\"jwks_kid\"/>\n                                    </L7p:EvaluateJsonPathExpressionV2>\n                                    <L7p:ComparisonAssertion>\n                                        <L7p:Expression1 stringValue=\"${jwks_kid.result}\"/>\n                                        <L7p:Expression2 stringValue=\"${jwt_kid}\"/>\n                                        <L7p:Predicates predicates=\"included\">\n                                        <L7p:item binary=\"included\">\n                                        <L7p:RightValue stringValue=\"${jwt_kid}\"/>\n                                        </L7p:item>\n                                        </L7p:Predicates>\n                                    </L7p:ComparisonAssertion>\n                                    <L7p:EvaluateJsonPathExpressionV2>\n                                        <L7p:AssertionComment assertionComment=\"included\">\n                                            <L7p:Properties mapValue=\"included\">\n                                            <L7p:entry>\n                                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                            <L7p:value stringValue=\"the first item in x5c is the client certificate\"/>\n                                            </L7p:entry>\n                                            </L7p:Properties>\n                                        </L7p:AssertionComment>\n                                        <L7p:Expression stringValue=\"x5c[0]\"/>\n                                        <L7p:OtherTargetMessageVariable stringValue=\"jwks_key_json\"/>\n                                        <L7p:Target target=\"OTHER\"/>\n                                        <L7p:VariablePrefix stringValue=\"clientCertificate\"/>\n                                    </L7p:EvaluateJsonPathExpressionV2>\n                                    <L7p:EncodeDecode>\n                                       <L7p:CharacterEncoding stringValueNull=\"null\"/>\n                                       <L7p:SourceVariableName stringValue=\"clientCertificate.result\"/>\n                                       <L7p:TargetDataType variableDataType=\"cert\"/>\n                                       <L7p:TargetVariableName stringValue=\"clientX5Cert\"/>\n                                       <L7p:TransformType transformType=\"BASE64_DECODE\"/>\n                                    </L7p:EncodeDecode>\n                                    <L7p:CertificateAttributes>\n                                        <L7p:SourceVariable stringValue=\"clientX5Cert\"/>\n                                        <L7p:SourceVariableEnabled booleanValue=\"true\"/>\n                                    </L7p:CertificateAttributes>\n                                    <L7p:SetVariable>\n                                        <L7p:Base64Expression stringValue=\"JHtjZXJ0aWZpY2F0ZS50aHVtYnByaW50U0hBMjU2fQ==\"/>\n                                        <L7p:VariableToSet stringValue=\"mTLS_certificate_thumbprint\"/>\n                                    </L7p:SetVariable>\n                                    <L7p:SetVariable>\n                                        <L7p:Base64Expression stringValue=\"dHJ1ZQ==\"/>\n                                        <L7p:VariableToSet stringValue=\"jwks_key.break\"/>\n                                    </L7p:SetVariable>\n                                </wsp:All>\n                                <L7p:TrueAssertion>\n                                    <L7p:AssertionComment assertionComment=\"included\">\n                                    <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"//never fail run each assertion\"/>\n                                    </L7p:entry>\n                                    </L7p:Properties>\n                                    </L7p:AssertionComment>\n                                </L7p:TrueAssertion>\n                            </wsp:OneOrMore>\n                            <L7p:assertionComment>\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// loop through all keys\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:assertionComment>\n                        </L7p:ForEachLoop>\n                    </wsp:All>\n                </wsp:OneOrMore>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// auth_method = &quot;private_key_jwt&quot;\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// client_secret_jwt or private_key_jwt\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:All wsp:Usage=\"Required\">\n            <L7p:Encapsulated>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// extracts jwt values for validation\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"6a3c3ed0-ec52-4a6f-b8a0-424fc9804cff\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Client JWT Values\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwt_header\"/>\n                        <L7p:value stringValue=\"${client_jwt.header}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"jwt_payload\"/>\n                        <L7p:value stringValue=\"${client_jwt.payload}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <wsp:OneOrMore wsp:Usage=\"Required\">\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// token_endpoint_auth_signing_alg is not provided during registration\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${client_auth_signing_alg}\"/>\n                        <L7p:Expression2 stringValue=\"\"/>\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:Operator operator=\"EMPTY\"/>\n                                <L7p:RightValue stringValue=\"\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// validate if token_endpoint_auth_method is provided \"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${client_auth_method}\"/>\n                        <L7p:Expression2 stringValue=\"private_key_jwt\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"private_key_jwt\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// check against RS256 for private_key_jwt auth method\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${jwt_alg}\"/>\n                        <L7p:Expression2 stringValue=\"RS256\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"RS256\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"private_key_jwt\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// token_endpoint_auth_signing_alg is not provided during registration\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:All>\n                <wsp:All wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// token_endpoint_auth_signing_alg is not provided during registration\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${client_auth_signing_alg}\"/>\n                        <L7p:Expression2 stringValue=\"\"/>\n                        <L7p:Operator operator=\"EMPTY\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:Operator operator=\"EMPTY\"/>\n                                <L7p:RightValue stringValue=\"\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// validate if token_endpoint_auth_method is provided \"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${client_auth_method}\"/>\n                        <L7p:Expression2 stringValue=\"client_secret_jwt\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"client_secret_jwt\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                    <L7p:value stringValue=\"// check against HS256 for client_secret_jwt auth method\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Expression1 stringValue=\"${jwt_alg}\"/>\n                        <L7p:Expression2 stringValue=\"HS256\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:CaseSensitive booleanValue=\"false\"/>\n                                <L7p:RightValue stringValue=\"HS256\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"client_secret_jwt\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// token_endpoint_auth_signing_alg is not provided during registration\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:All>\n                <L7p:ComparisonAssertion>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// token_endpoint_auth_signing_alg is provided, check if it matches the alg specified in the request header\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${jwt_alg}\"/>\n                    <L7p:Expression2 stringValue=\"${client_auth_signing_alg}\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"${client_auth_signing_alg}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"Validate token_endpoint_auth_signing_alg\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:OneOrMore>\n            <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// issuer MUST be equal to client_id\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:CaseSensitive booleanValue=\"false\"/>\n                <L7p:Expression1 stringValue=\"${iss}\"/>\n                <L7p:Expression2 stringValue=\"${client_id}\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:RightValue stringValue=\"${client_id}\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// subject MUST be equal to client_id\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:CaseSensitive booleanValue=\"false\"/>\n                <L7p:Expression1 stringValue=\"${sub}\"/>\n                <L7p:Expression2 stringValue=\"${client_id}\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:RightValue stringValue=\"${client_id}\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// aud claim MUST contain server's endpoint\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:CaseSensitive booleanValue=\"false\"/>\n                <L7p:Expression1 stringValue=\"${aud}\"/>\n                <L7p:Expression2 stringValue=\"${audience}\"/>\n                <L7p:MultivaluedComparison multivaluedComparison=\"ANY\"/>\n                <L7p:Operator operator=\"CONTAINS\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Operator operator=\"CONTAINS\"/>\n                        <L7p:RightValue stringValue=\"${audience}\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"// check expiry\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:CaseSensitive booleanValue=\"false\"/>\n                <L7p:Expression1 stringValue=\"${exp}\"/>\n                <L7p:Expression2 stringValue=\"${gateway.time.seconds}\"/>\n                <L7p:Operator operator=\"GT\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:CaseSensitive booleanValue=\"false\"/>\n                        <L7p:Operator operator=\"GT\"/>\n                        <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <L7p:CommentAssertion>\n                <L7p:Comment stringValue=\"=== Token should only be used once. If it is replayed, return error ===\"/>\n            </L7p:CommentAssertion>\n            <L7p:CommentAssertion>\n                <L7p:Comment stringValue=\"Spec recommends that the client JWT should not have expiry dates too far in the future\"/>\n            </L7p:CommentAssertion>\n            <L7p:CommentAssertion>\n                <L7p:Comment stringValue=\"Narrower window of valid JWT reduces the risk of replay attack\"/>\n            </L7p:CommentAssertion>\n            <L7p:Encapsulated>\n                <L7p:EncapsulatedAssertionConfigGuid stringValue=\"b289856a-776b-47d9-9177-cf252b1e2bc4\"/>\n                <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Replay Attack Protection\"/>\n                <L7p:Parameters mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"cacheId\"/>\n                        <L7p:value stringValue=\"clientJwtReplay\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"exp\"/>\n                        <L7p:value stringValue=\"${exp}\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"identifier\"/>\n                        <L7p:value stringValue=\"${jti}\"/>\n                    </L7p:entry>\n                </L7p:Parameters>\n            </L7p:Encapsulated>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"validate\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:All>\n    </wsp:All>\n</wsp:Policy>"
  }
}