{
  "goid": "e001cfd0c1c1ffaa18e187b5e72fd9e7",
  "guid": "b96a8705-2856-4a40-b0e7-2ab4c8e223c1",
  "name": "OTK Client Export",
  "policyType": "FRAGMENT",
  "checksum": "bf794a2cf8c983272122a8dd944309a56795560b",
  "folderPath": "/OTK/Policy Fragments/manage/client",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === ***  THIS POLICY IS READ ONLY ***\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === If you have the need to customize this policy\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === please contact CA APIM Support so we can improve customization capability\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Builds the JSON returned when a user exports client information for SDK configuration\"/>\n        </L7p:CommentAssertion>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"2e6e2ef3-a36f-4548-a2c4-7b369b7ae184\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Variable Configuration\"/>\n        </L7p:Encapsulated>\n        <L7p:SetVariable>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"initialize\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"will be overwritten in the case of an error\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Base64Expression stringValue=\"\"/>\n            <L7p:VariableToSet stringValue=\"error.code\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"YXBwbGljYXRpb24vanNvbjsgY2hhcnNldD1VVEYtOA==\"/>\n            <L7p:VariableToSet stringValue=\"content-type\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtpbmNvbWluZ194bWwubWFpbnBhcnR9\"/>\n            <L7p:ContentType stringValue=\"text/xml;charset=UTF-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"xmlClientInfo\"/>\n        </L7p:SetVariable>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ResponseXpathAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"Verify\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"Verify that only one client_id gets exported\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:VariablePrefix stringValue=\"\"/>\n                <L7p:XmlMsgSrc stringValue=\"xmlClientInfo\"/>\n                <L7p:XpathExpression xpathExpressionValue=\"included\">\n                    <L7p:Expression stringValue=\"count(/ns:values/ns:keys/ns:values/ns:value)=1\"/>\n                    <L7p:Namespaces mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"ns\"/>\n                            <L7p:value stringValue=\"http://ns.l7tech.com/2012/11/otk-clientstore\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"s\"/>\n                            <L7p:value stringValue=\"http://schemas.xmlsoap.org/soap/envelope/\"/>\n                        </L7p:entry>\n                    </L7p:Namespaces>\n                    <L7p:XpathVersion xpathVersion=\"XPATH_1_0\"/>\n                </L7p:XpathExpression>\n            </L7p:ResponseXpathAssertion>\n            <L7p:ResponseXpathAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"Verify\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"Verify that the requested client_key is included in the provided input message\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:VariablePrefix stringValue=\"\"/>\n                <L7p:XmlMsgSrc stringValue=\"xmlClientInfo\"/>\n                <L7p:XpathExpression xpathExpressionValue=\"included\">\n                    <L7p:Expression stringValue=\"/ns:values/ns:keys/ns:values/ns:value/ns:client_key/text()=$client_key\"/>\n                    <L7p:Namespaces mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"ns\"/>\n                            <L7p:value stringValue=\"http://ns.l7tech.com/2012/11/otk-clientstore\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"s\"/>\n                            <L7p:value stringValue=\"http://schemas.xmlsoap.org/soap/envelope/\"/>\n                        </L7p:entry>\n                    </L7p:Namespaces>\n                    <L7p:XpathVersion xpathVersion=\"XPATH_1_0\"/>\n                </L7p:XpathExpression>\n            </L7p:ResponseXpathAssertion>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MjAx\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n            </wsp:All>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:LookupTrustedCertificate>\n                <L7p:TrustedCertificateName stringValue=\"${oauth2_server_certificate}\"/>\n                <L7p:VariableName stringValue=\"certificate\"/>\n            </L7p:LookupTrustedCertificate>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:AuditDetailAssertion>\n                    <L7p:Detail stringValue=\"Certificate lookup failed! attempted to look up ${oauth2_server_certificate}\"/>\n                </L7p:AuditDetailAssertion>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MTMy\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"FAIL\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"Look up certificate\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtjZXJ0aWZpY2F0ZS5wZW19\"/>\n            <L7p:VariableToSet stringValue=\"certificate.pem\"/>\n        </L7p:SetVariable>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"certificate.pem\"/>\n            <L7p:Regex stringValue=\"\\n(.)\"/>\n            <L7p:RegexName stringValue=\"Normalize Certificate\"/>\n            <L7p:Replace booleanValue=\"true\"/>\n            <L7p:Replacement stringValue=\"&quot;,&quot;$1\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"certificate.pem\"/>\n            <L7p:Regex stringValue=\"\\r\"/>\n            <L7p:RegexName stringValue=\"Remove carriage return\"/>\n            <L7p:Replace booleanValue=\"true\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"f0db12ba-404c-4674-a54e-571ed6d2f1bc\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"MAG Variable Configuration\"/>\n            <L7p:NoOpIfConfigMissing booleanValue=\"true\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"incoming\"/>\n                    <L7p:value stringValue=\"resp\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"incoming-resp\"/>\n                    <L7p:value stringValue=\"resp\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"parent-element\"/>\n                    <L7p:value stringValue=\"${parent_element}\"/>\n                </L7p:entry>\n                <L7p:entry>\n                    <L7p:key stringValue=\"parent_element\"/>\n                    <L7p:value stringValue=\"${parent_element}\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"75c95854-92b4-4293-92e5-6d63b6d94812\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"MAS Variable Configuration\"/>\n            <L7p:NoOpIfConfigMissing booleanValue=\"true\"/>\n        </L7p:Encapsulated>\n        <L7p:XslTransformation>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"Escape quotes\"/>\n                    </L7p:entry>\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Escape quotes for xml to json transformation\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:Direction intValue=\"-1\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"xmlClientInfo\"/>\n            <L7p:ResourceInfo staticResourceInfo=\"included\">\n                <L7p:Document stringValueReference=\"inline\"><![CDATA[<xsl:stylesheet version=\"1.0\" xmlns:mag=\"http://ns.l7tech.com/2012/11/otk-clientstore\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n  <xsl:output indent=\"yes\" method=\"xml\"/>\n\n    <xsl:template match=\"@*|node()\">\n        <xsl:copy>\n            <xsl:apply-templates select=\"@*|node()\"/>\n        </xsl:copy>\n    </xsl:template>\n\n    <xsl:template match=\"*[not(self::mag:client_custom)][not(self::mag:client_key_custom)]/text()\">\n      <xsl:call-template name=\"replace\">\n       <xsl:with-param name=\"pS\" select=\"normalize-space(.)\"/>\n     </xsl:call-template>\n    </xsl:template>\n\n <xsl:template name=\"replace\">\n  <xsl:param name=\"pS\"/>\n  <xsl:param name=\"pTarget\" select=\"'&quot;'\"/>\n  <xsl:param name=\"pReplacement\" select=\"'\\&quot;'\"/>\n\n  <xsl:if test=\"$pS\">\n   <xsl:value-of select=\"substring-before(concat($pS,$pTarget), $pTarget)\"/>\n   <xsl:if test=\"contains($pS, $pTarget)\">\n     <xsl:value-of select=\"$pReplacement\"/>\n   </xsl:if>\n   <xsl:call-template name=\"replace\">\n     <xsl:with-param name=\"pS\" select=\"substring-after($pS, $pTarget)\"/>\n     <xsl:with-param name=\"pTarget\" select=\"$pTarget\"/>\n     <xsl:with-param name=\"pReplacement\" select=\"$pReplacement\"/>\n   </xsl:call-template>\n  </xsl:if>\n </xsl:template>\n\n</xsl:stylesheet>]]></L7p:Document>\n            </L7p:ResourceInfo>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:TransformName stringValue=\"\"/>\n            <L7p:XsltVersion stringValue=\"1.0\"/>\n        </L7p:XslTransformation>\n        <L7p:XslTransformation>\n            <L7p:Direction intValue=\"-1\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"xmlClientInfo\"/>\n            <L7p:ResourceInfo staticResourceInfo=\"included\">\n                <L7p:Document stringValueReference=\"inline\"><![CDATA[<xsl:stylesheet version=\"1.0\" xmlns:mag=\"http://ns.l7tech.com/2012/11/otk-clientstore\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n                                <xsl:output method=\"text\"/>\n                                <xsl:param name=\"certificate.pem\"/>\n                                <xsl:param name=\"oauth2_server_hostname\"/>\n                                <xsl:param name=\"oauth2_server_port\"/>\n                                <xsl:param name=\"oauth2_server_url_prefix\"/>\n\n                                <xsl:param name=\"oauth2_auth_path\"/>\n                                <xsl:param name=\"oauth2_token_path\"/>\n                                <xsl:param name=\"oauth2_token_revocation_path\"/>\n                                <xsl:param name=\"usersession_logout_path\"/>\n\n                                <xsl:param name=\"userinfo_path\"/>\n                                <xsl:param name=\"usersession_status_path\"/>\n\n                                <xsl:param name=\"mas_json\"/>\n                                <xsl:param name=\"mag_json\"/>\n\n                                <xsl:param name=\"export_custom\"/>\n                                <xsl:param name=\"expose_client_secret\"/>\n\n                                <xsl:strip-space elements=\"*\"/>\n\n                                <xsl:template match=\"text()\">\n                                <xsl:value-of select=\"normalize-space()\"/>\n                                </xsl:template>\n\n                                <xsl:strip-space elements=\"certificate.pem\"/>\n\n\n                                <xsl:template match=\"/mag:values\">\n                                {\n                                \"server\": {\n                                \"hostname\": \"<xsl:value-of select=\"$oauth2_server_hostname\"/>\",\n                                \"port\": <xsl:value-of select=\"$oauth2_server_port\"/>,\n                                \"prefix\": \"<xsl:value-of select=\"$oauth2_server_url_prefix\"/>\",\n                                \"server_certs\": [\n                                [\n                                \"<xsl:value-of select=\"normalize-space($certificate.pem)\"/>\"\n                                ]\n                                ]\n                                },\n                                \"oauth\": {\n                                \"client\": {\n                                \"organization\": \"<xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:organization\"/>\",\n                                \"description\": \"<xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:description\"/>\",\n                                \"client_name\": \"<xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:name\"/>\",\n                                \"client_type\": \"<xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:type\"/>\",\n                                \"registered_by\": \"<xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:registered_by\"/>\",\n                                \"client_custom\": <xsl:value-of select=\"mag:clients/mag:values/mag:value/mag:client_custom\"/>,\n                                \"client_ids\": [\n                                <xsl:for-each select=\"mag:keys/mag:values/mag:value\">\n                                {\n                                \"client_id\": \"<xsl:value-of select=\"mag:client_key\"/>\",\n                                \"client_secret\":\"<xsl:if test=\"$expose_client_secret = 'true'\"><xsl:value-of select=\"mag:secret\"/></xsl:if>\",\n                                \"scope\": \"<xsl:value-of select=\"mag:scope\"/>\",\n                                \"resource\": \"<xsl:value-of select=\"mag:resource\"/>\",\n                                \"redirect_uri\": \"<xsl:value-of select=\"mag:callback\"/>\",\n                                \"environment\": \"<xsl:value-of select=\"mag:environment\"/>\",\n                                \"status\": \"<xsl:value-of select=\"mag:status\"/>\",\n                                \"registered_by\": \"<xsl:value-of select=\"mag:created_by\"/>\",\n                                \"service_ids\": \"<xsl:value-of select=\"mag:serviceids\"/>\",\n                                \"account_plan_mapping_ids\": \"<xsl:value-of select=\"mag:accountplanmappingids\"/>\",\n                                \"client_key_custom\": <xsl:value-of select=\"mag:client_key_custom\"/>\n                                }<xsl:if test=\"position() != last()\">,</xsl:if>\n                                </xsl:for-each>\n                                ]\n                                },\n                                \"system_endpoints\": {\n                                \"authorization_endpoint_path\": \"<xsl:value-of select=\"$oauth2_auth_path\"/>\",\n                                \"token_endpoint_path\": \"<xsl:value-of select=\"$oauth2_token_path\"/>\",\n                                \"token_revocation_endpoint_path\": \"<xsl:value-of select=\"$oauth2_token_revocation_path\"/>\",\n                                \"usersession_logout_endpoint_path\": \"<xsl:value-of select=\"$usersession_logout_path\"/>\",\n                                \"usersession_status_endpoint_path\": \"<xsl:value-of select=\"$usersession_status_path\"/>\"\n                                },\n                                \"oauth_protected_endpoints\": {\n                                \"userinfo_endpoint_path\": \"<xsl:value-of select=\"$userinfo_path\"/>\"\n                                }\n                                }<xsl:if test=\"$mas_json\">,<xsl:value-of select=\"normalize-space($mas_json)\" xml:space=\"preserve\"/></xsl:if>\n                                <xsl:if test=\"$mag_json\">,<xsl:value-of select=\"normalize-space($mag_json)\" xml:space=\"preserve\"/></xsl:if>,\n                                \"custom\": {\n                                <xsl:value-of select=\"$export_custom\"/>\n                                }\n                                }</xsl:template>\n                                </xsl:stylesheet>]]></L7p:Document>\n            </L7p:ResourceInfo>\n            <L7p:Target target=\"OTHER\"/>\n            <L7p:TransformName stringValue=\"\"/>\n            <L7p:XsltVersion stringValue=\"1.0\"/>\n        </L7p:XslTransformation>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHt4bWxDbGllbnRJbmZvLm1haW5wYXJ0fQ==\"/>\n            <L7p:VariableToSet stringValue=\"resp\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtyZXNwfQ==\"/>\n            <L7p:ContentType stringValue=\"application/json;charset=UTF-8\"/>\n            <L7p:DataType variableDataType=\"message\"/>\n            <L7p:VariableToSet stringValue=\"resp\"/>\n        </L7p:SetVariable>\n    </wsp:All>\n</wsp:Policy>"
  }
}