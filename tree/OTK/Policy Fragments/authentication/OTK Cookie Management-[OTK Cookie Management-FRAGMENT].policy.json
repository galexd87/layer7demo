{
  "goid": "1fad231a4cd7a16592b8c7de83b25945",
  "guid": "5b805783-1e94-420c-ad50-49dadf1808aa",
  "name": "OTK Cookie Management",
  "policyType": "FRAGMENT",
  "checksum": "470bcfac7128d34af90f47183c6bc4f8c1468f1d",
  "folderPath": "/OTK/Policy Fragments/authentication",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Handles cookie validation. Also creates cookies\"/>\n        </L7p:CommentAssertion>\n        <L7p:Include>\n            <L7p:PolicyGuid stringValue=\"08572488-58f3-4e40-babd-623926c306ec\"/>\n        </L7p:Include>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtjb29raWVOYW1lfT07IEV4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQ7IFBhdGg9LzsgU2VjdXJlOyBIdHRwT25seQ==\"/>\n            <L7p:VariableToSet stringValue=\"setCookieDelete\"/>\n        </L7p:SetVariable>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${task}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"boolean\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"false\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Regex>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:CaptureVar stringValue=\"authUserCookie\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"cookie\"/>\n                    <L7p:PatternContainsVariables booleanValue=\"true\"/>\n                    <L7p:Regex stringValue=\"${cookieName}=([a-zA-Z0-9-_/%]{1,128})\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHthdXRoVXNlckNvb2tpZVsxXX0=\"/>\n                    <L7p:VariableToSet stringValue=\"cookieContent\"/>\n                </L7p:SetVariable>\n                <L7p:EncodeDecode>\n                    <L7p:SourceVariableName stringValue=\"cookieContent\"/>\n                    <L7p:TargetDataType variableDataType=\"string\"/>\n                    <L7p:TargetVariableName stringValue=\"cookieContent\"/>\n                    <L7p:TransformType transformType=\"URL_DECODE\"/>\n                </L7p:EncodeDecode>\n                <L7p:Split>\n                    <L7p:InputVariable stringValue=\"cookieContent\"/>\n                    <L7p:OutputVariable stringValue=\"userSession\"/>\n                    <L7p:SplitPattern stringValue=\"|\"/>\n                    <L7p:SplitPatternRegEx booleanValue=\"false\"/>\n                </L7p:Split>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1c2VyU2Vzc2lvblswXX0=\"/>\n                    <L7p:VariableToSet stringValue=\"cookieID\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1c2VyU2Vzc2lvblsxXX0=\"/>\n                    <L7p:VariableToSet stringValue=\"expiration\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1c2VyU2Vzc2lvblsyXX0=\"/>\n                    <L7p:VariableToSet stringValue=\"signature\"/>\n                </L7p:SetVariable>\n                <L7p:AuditDetailAssertion>\n                    <L7p:Detail stringValue=\"expiration:  '${expiration}', now: '${gateway.time.seconds}', content: '${cookieContent}', cookie: '${cookie}'\"/>\n                    <L7p:Enabled booleanValue=\"false\"/>\n                </L7p:AuditDetailAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${expiration}\"/>\n                    <L7p:Expression2 stringValue=\"${gateway.time.seconds}\"/>\n                    <L7p:Operator operator=\"GT\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Operator operator=\"GT\"/>\n                            <L7p:RightValue stringValue=\"${gateway.time.seconds}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:GenerateSecurityHash>\n                    <L7p:Base64Data stringValue=\"JHtjb29raWVJRH18JHtleHBpcmF0aW9ufXw=\"/>\n                    <L7p:KeyText stringValue=\"${cookieKey}\"/>\n                    <L7p:LineBreak lineBreak=\"CR-LF\"/>\n                    <L7p:TargetOutputVariable stringValue=\"actualHash\"/>\n                </L7p:GenerateSecurityHash>\n                <L7p:Regex>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"actualHash\"/>\n                    <L7p:Regex stringValue=\"[ =+/]\"/>\n                    <L7p:Replace booleanValue=\"true\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${actualHash}\"/>\n                    <L7p:Expression2 stringValue=\"${signature}\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:RightValue stringValue=\"${signature}\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"4e4bc164-3fa2-4b15-ba65-31cef45b84b0\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Session GET\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheAge\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheId\"/>\n                            <L7p:value stringValue=\"userSessionIDCacheV2\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheKey\"/>\n                            <L7p:value stringValue=\"${cookieID}\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n                <L7p:ResponseXpathAssertion>\n                    <L7p:VariablePrefix stringValue=\"cookieValue\"/>\n                    <L7p:XmlMsgSrc stringValue=\"resp\"/>\n                    <L7p:XpathExpression xpathExpressionValue=\"included\">\n                        <L7p:Expression stringValue=\"/ns:found/ns:value/text()\"/>\n                        <L7p:Namespaces mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"ns\"/>\n                                <L7p:value stringValue=\"http://ns.l7tech.com/2012/11/otk-session\"/>\n                            </L7p:entry>\n                            <L7p:entry>\n                                <L7p:key stringValue=\"s\"/>\n                                <L7p:value stringValue=\"http://schemas.xmlsoap.org/soap/envelope/\"/>\n                            </L7p:entry>\n                        </L7p:Namespaces>\n                        <L7p:XpathVersion xpathVersion=\"XPATH_1_0\"/>\n                    </L7p:XpathExpression>\n                </L7p:ResponseXpathAssertion>\n                <L7p:EncodeDecode>\n                    <L7p:SourceVariableName stringValue=\"cookieValue.result\"/>\n                    <L7p:TargetDataType variableDataType=\"string\"/>\n                    <L7p:TargetVariableName stringValue=\"cookieValue\"/>\n                    <L7p:TransformType transformType=\"URL_DECODE\"/>\n                </L7p:EncodeDecode>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"validate\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${task}\"/>\n                    <L7p:Operator operatorNull=\"null\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item dataType=\"included\">\n                            <L7p:Type variableDataType=\"boolean\"/>\n                        </L7p:item>\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"true\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:UUIDGenerator>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"// sessionID\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:MaximumQuantity intValue=\"1\"/>\n                    <L7p:TargetVariable stringValue=\"cookieID\"/>\n                </L7p:UUIDGenerator>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"\"/>\n                    <L7p:DataType variableDataType=\"dateTime\"/>\n                    <L7p:DateOffsetExpression stringValue=\"${lifetime}\"/>\n                    <L7p:VariableToSet stringValue=\"expiration\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtjb29raWVJRFswXX18JHtleHBpcmF0aW9uLnNlY29uZHN9fA==\"/>\n                    <L7p:VariableToSet stringValue=\"cookieContent\"/>\n                </L7p:SetVariable>\n                <L7p:GenerateSecurityHash>\n                    <L7p:Base64Data stringValue=\"JHtjb29raWVDb250ZW50fQ==\"/>\n                    <L7p:KeyText stringValue=\"${cookieKey}\"/>\n                    <L7p:LineBreak lineBreak=\"CR-LF\"/>\n                    <L7p:TargetOutputVariable stringValue=\"actualHash\"/>\n                </L7p:GenerateSecurityHash>\n                <L7p:Regex>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"actualHash\"/>\n                    <L7p:Regex stringValue=\"[ =+/]\"/>\n                    <L7p:Replace booleanValue=\"true\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtjb29raWVDb250ZW50fSR7YWN0dWFsSGFzaH0=\"/>\n                    <L7p:VariableToSet stringValue=\"cookieContent\"/>\n                </L7p:SetVariable>\n                <L7p:EncodeDecode>\n                    <L7p:SourceVariableName stringValue=\"cookieContent\"/>\n                    <L7p:TargetDataType variableDataType=\"string\"/>\n                    <L7p:TargetVariableName stringValue=\"cookieContent\"/>\n                    <L7p:TransformType transformType=\"URL_ENCODE\"/>\n                </L7p:EncodeDecode>\n                <L7p:Encapsulated>\n                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"dd360775-0fec-47db-8b45-059d995b262d\"/>\n                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Session - Store\"/>\n                    <L7p:Parameters mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheAge\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheId\"/>\n                            <L7p:value stringValue=\"userSessionIDCacheV2\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheKey\"/>\n                            <L7p:value stringValue=\"${cookieID}\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheMaxEntries\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"cacheMaxSize\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"dbAge\"/>\n                            <L7p:value stringValue=\"\"/>\n                        </L7p:entry>\n                        <L7p:entry>\n                            <L7p:key stringValue=\"value\"/>\n                            <L7p:value stringValue=\"${cookieValue}\"/>\n                        </L7p:entry>\n                    </L7p:Parameters>\n                </L7p:Encapsulated>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"create\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MjAy\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"error\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"// create or validate\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtjb29raWVOYW1lfT0ke2Nvb2tpZUNvbnRlbnR9OyBQYXRoPS87IFNlY3VyZTsgSHR0cE9ubHk=\"/>\n            <L7p:VariableToSet stringValue=\"setCookie\"/>\n        </L7p:SetVariable>\n    </wsp:All>\n</wsp:Policy>"
  }
}