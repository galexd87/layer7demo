{
  "goid": "3f42c73314d6b36fb7ebe93f600808ff",
  "guid": "2714f797-3e21-4954-a1d8-894b18e338af",
  "name": "OTK Token Count",
  "policyType": "FRAGMENT",
  "checksum": "6f15e25f3e600ba0568df539f2670d7fd33d5a42",
  "folderPath": "/OTK/Policy Fragments/pof",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === ***  THIS POLICY IS READ ONLY ***\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === If you have the need to customize this policy\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === please contact CA APIM Support so we can improve customization capability\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Ensure OTK Token count is within configured limits\"/>\n        </L7p:CommentAssertion>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"Skip counting the tokens\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Expression1 stringValue=\"${max_oauth_token_behaviour}\"/>\n                <L7p:Expression2 stringValue=\"none\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:RightValue stringValue=\"none\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n\t\t\t  <L7p:ComparisonAssertion>\n                <L7p:AssertionComment assertionComment=\"included\">\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                            <L7p:value stringValue=\"Skip counting the tokens\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:AssertionComment>\n                <L7p:Expression1 stringValue=\"${max_oauth_token_count}\"/>\n                <L7p:Expression2 stringValue=\"0\"/>\n                <L7p:Operator operator=\"LE\"/>\n                <L7p:Predicates predicates=\"included\">\n                    <L7p:item binary=\"included\">\n                        <L7p:Operator operator=\"LE\"/>\n                        <L7p:RightValue stringValue=\"0\"/>\n                    </L7p:item>\n                </L7p:Predicates>\n            </L7p:ComparisonAssertion>\n            <wsp:All wsp:Usage=\"Required\">\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:Expression1 stringValue=\"${dbsystem}\"/>\n                            <L7p:Expression2 stringValue=\"cassandra\"/>\n                            <L7p:Operator operator=\"NE\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:Operator operator=\"NE\"/>\n                                    <L7p:RightValue stringValue=\"cassandra\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:Encapsulated>\n                            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"feb37412-4c25-48a7-9bc3-e47cde29ba4f\"/>\n                            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Token DB Count Check\"/>\n                            <L7p:NoOpIfConfigMissing booleanValue=\"true\"/>\n                        </L7p:Encapsulated>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"MySQL, Oracle\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:Expression1 stringValue=\"${dbsystem}\"/>\n                            <L7p:Expression2 stringValue=\"cassandra\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"cassandra\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:Encapsulated>\n                            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"00235830-1a36-4a46-9849-f7af651a0b57\"/>\n                            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Token NoSQL Count Check\"/>\n                            <L7p:NoOpIfConfigMissing booleanValue=\"true\"/>\n                        </L7p:Encapsulated>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Cassandra\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:AuditDetailAssertion>\n                            <L7p:Detail stringValue=\"Unable to retrieve Token count from the database\"/>\n                        </L7p:AuditDetailAssertion>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"MDAw\"/>\n                            <L7p:VariableToSet stringValue=\"error.code\"/>\n                        </L7p:SetVariable>\n                        <L7p:FalseAssertion/>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Error\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"Get current count\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <wsp:All wsp:Usage=\"Required\">\n                    <wsp:OneOrMore wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:AssertionComment assertionComment=\"included\">\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"No Results\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:AssertionComment>\n                            <L7p:Expression1 stringValue=\"${tokenQuery.queryresult.count}\"/>\n                            <L7p:Expression2 stringValue=\"0\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"0\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <wsp:All wsp:Usage=\"Required\">\n                            <L7p:ComparisonAssertion>\n                                <L7p:Expression1 stringValue=\"${tokenQuery.queryresult.count}\"/>\n                                <L7p:Expression2 stringValue=\"0\"/>\n                                <L7p:Operator operator=\"GT\"/>\n                                <L7p:Predicates predicates=\"included\">\n                                    <L7p:item binary=\"included\">\n                                    <L7p:Operator operator=\"GT\"/>\n                                    <L7p:RightValue stringValue=\"0\"/>\n                                    </L7p:item>\n                                </L7p:Predicates>\n                            </L7p:ComparisonAssertion>\n                            <L7p:SetVariable>\n                                <L7p:Base64Expression stringValue=\"JHt0b2tlblF1ZXJ5LmFjY2Vzc190b2tlbnNbMF19\"/>\n                                <L7p:VariableToSet stringValue=\"oldestToken\"/>\n                            </L7p:SetVariable>\n                            <L7p:SetVariable>\n                                <L7p:Base64Expression stringValue=\"JHt0b2tlblF1ZXJ5LmNyZWF0ZWRbMF19\"/>\n                                <L7p:VariableToSet stringValue=\"oldestTokenCreated\"/>\n                            </L7p:SetVariable>\n                            <L7p:assertionComment>\n                                <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Results\"/>\n                                    </L7p:entry>\n                                </L7p:Properties>\n                            </L7p:assertionComment>\n                        </wsp:All>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Check results\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:OneOrMore>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"Set count and oldest token\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:All>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <L7p:ComparisonAssertion>\n                        <L7p:AssertionComment assertionComment=\"included\">\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Within limit\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:AssertionComment>\n                        <L7p:Expression1 stringValue=\"${tokenQuery.queryresult.count}\"/>\n                        <L7p:Expression2 stringValue=\"${max_oauth_token_count}\"/>\n                        <L7p:Operator operator=\"LT\"/>\n                        <L7p:Predicates predicates=\"included\">\n                            <L7p:item binary=\"included\">\n                                <L7p:Operator operator=\"LT\"/>\n                                <L7p:RightValue stringValue=\"${max_oauth_token_count}\"/>\n                            </L7p:item>\n                        </L7p:Predicates>\n                    </L7p:ComparisonAssertion>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:Expression1 stringValue=\"${tokenQuery.queryresult.count}\"/>\n                            <L7p:Expression2 stringValue=\"${max_oauth_token_count}\"/>\n                            <L7p:Operator operator=\"GE\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:Operator operator=\"GE\"/>\n                                    <L7p:RightValue stringValue=\"${max_oauth_token_count}\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <wsp:OneOrMore wsp:Usage=\"Required\">\n                            <wsp:All wsp:Usage=\"Required\">\n                                <L7p:ComparisonAssertion>\n                                    <L7p:Expression1 stringValue=\"${max_oauth_token_behaviour}\"/>\n                                    <L7p:Expression2 stringValue=\"error\"/>\n                                    <L7p:Predicates predicates=\"included\">\n                                    <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"error\"/>\n                                    </L7p:item>\n                                    </L7p:Predicates>\n                                </L7p:ComparisonAssertion>\n                                <L7p:SetVariable>\n                                    <L7p:Base64Expression stringValue=\"MTM1\"/>\n                                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                                </L7p:SetVariable>\n                                <L7p:FalseAssertion/>\n                                <L7p:assertionComment>\n                                    <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Error\"/>\n                                    </L7p:entry>\n                                    </L7p:Properties>\n                                </L7p:assertionComment>\n                            </wsp:All>\n                            <wsp:All wsp:Usage=\"Required\">\n                                <L7p:ComparisonAssertion>\n                                    <L7p:Expression1 stringValue=\"${max_oauth_token_behaviour}\"/>\n                                    <L7p:Expression2 stringValue=\"cycle\"/>\n                                    <L7p:Predicates predicates=\"included\">\n                                    <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"cycle\"/>\n                                    </L7p:item>\n                                    </L7p:Predicates>\n                                </L7p:ComparisonAssertion>\n                                <L7p:Encapsulated>\n                                    <L7p:AssertionComment assertionComment=\"included\">\n                                    <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Revoke oldest token\"/>\n                                    </L7p:entry>\n                                    </L7p:Properties>\n                                    </L7p:AssertionComment>\n                                    <L7p:EncapsulatedAssertionConfigGuid stringValue=\"b4d99254-0b3e-494a-825d-68db32c30072\"/>\n                                    <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Token Revocation\"/>\n                                    <L7p:Parameters mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"client_key\"/>\n                                    <L7p:value stringValue=\"\"/>\n                                    </L7p:entry>\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"resource_owner\"/>\n                                    <L7p:value stringValue=\"\"/>\n                                    </L7p:entry>\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"rtoken\"/>\n                                    <L7p:value stringValue=\"\"/>\n                                    </L7p:entry>\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"token\"/>\n                                    <L7p:value stringValue=\"${oldestToken}\"/>\n                                    </L7p:entry>\n                                    </L7p:Parameters>\n                                </L7p:Encapsulated>\n                                <L7p:assertionComment>\n                                    <L7p:Properties mapValue=\"included\">\n                                    <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Cycle\"/>\n                                    </L7p:entry>\n                                    </L7p:Properties>\n                                </L7p:assertionComment>\n                            </wsp:All>\n                        </wsp:OneOrMore>\n                        <L7p:assertionComment>\n                            <L7p:Properties mapValue=\"included\">\n                                <L7p:entry>\n                                    <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                    <L7p:value stringValue=\"Max reached\"/>\n                                </L7p:entry>\n                            </L7p:Properties>\n                        </L7p:assertionComment>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                                <L7p:value stringValue=\"Check count against limit\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n            </wsp:All>\n        </wsp:OneOrMore>\n    </wsp:All>\n</wsp:Policy>"
  }
}