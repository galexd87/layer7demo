{
  "goid": "e001cfd0c1c1ffaa18e187b5e72fd0f6",
  "guid": "31b00c3c-a333-4e44-8e00-6bfd51b974a8",
  "name": "OTK v2GenerateRequestMac",
  "policyType": "FRAGMENT",
  "checksum": "dc308cd9674b44e2ace44a52fc5e1919254ab218",
  "folderPath": "/OTK/Policy Fragments/pof",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === ***  THIS POLICY IS READ ONLY ***\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === If you have the need to customize this policy\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === please contact CA APIM Support so we can improve customization capability\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Generates request MAC using HMAC-SHA1 algorithm\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Inputs: timestamp_sec, nonce, http_method, url, ext, mac_key, mac_algorithm\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Outputs: mac\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Validate inputs ==========\"/>\n        </L7p:CommentAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${timestamp_sec}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"timestamp_sec\"/>\n            <L7p:ProceedIfPatternMatches booleanValue=\"false\"/>\n            <L7p:Regex stringValue=\"^0+\"/>\n            <L7p:RegexName stringValue=\"Timestamp must not have leading zeros\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"timestamp_sec\"/>\n            <L7p:ProceedIfPatternMatches booleanValue=\"false\"/>\n            <L7p:Regex stringValue=\"^-\"/>\n            <L7p:RegexName stringValue=\"Timestamp must be a positive number\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${nonce}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${http_method}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"http_method\"/>\n            <L7p:ProceedIfPatternMatches booleanValue=\"false\"/>\n            <L7p:Regex stringValue=\"[a-z]\"/>\n            <L7p:RegexName stringValue=\"HTTP method must be in upper case\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${url}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${mac_key}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${mac_algorithm}\"/>\n            <L7p:Expression2 stringValue=\"hmac-sha-1\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:RightValue stringValue=\"hmac-sha-1\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Break URL into parts (protocol, hostname+port, path) ==========\"/>\n        </L7p:CommentAssertion>\n        <L7p:Regex>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:CaptureVar stringValue=\"url_sub_string\"/>\n            <L7p:FindAll booleanValue=\"true\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"url\"/>\n            <L7p:Regex stringValue=\"([a-z]*)://([^/]*)(.*)\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHt1cmxfc3ViX3N0cmluZ1szXX0=\"/>\n            <L7p:VariableToSet stringValue=\"request_uri\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHt1cmxfc3ViX3N0cmluZ1syXX0=\"/>\n            <L7p:VariableToSet stringValue=\"url_hostname_port\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"\"/>\n            <L7p:VariableToSet stringValue=\"host\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"\"/>\n            <L7p:VariableToSet stringValue=\"port\"/>\n        </L7p:SetVariable>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:Regex>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:CaptureVar stringValue=\"url_hostname_port_sub_string\"/>\n                    <L7p:FindAll booleanValue=\"true\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"url_hostname_port\"/>\n                    <L7p:Regex stringValue=\"([^:]*):([0-9]*)\"/>\n                    <L7p:RegexName stringValue=\"get hostname and port number\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1cmxfaG9zdG5hbWVfcG9ydF9zdWJfc3RyaW5nWzFdfQ==\"/>\n                    <L7p:VariableToSet stringValue=\"host\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1cmxfaG9zdG5hbWVfcG9ydF9zdWJfc3RyaW5nWzJdfQ==\"/>\n                    <L7p:VariableToSet stringValue=\"port\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"port is specified\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt1cmxfaG9zdG5hbWVfcG9ydH0=\"/>\n                    <L7p:VariableToSet stringValue=\"host\"/>\n                </L7p:SetVariable>\n                <wsp:OneOrMore wsp:Usage=\"Required\">\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:Expression1 stringValue=\"${url_sub_string[1]}\"/>\n                            <L7p:Expression2 stringValue=\"http\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"http\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"ODA=\"/>\n                            <L7p:VariableToSet stringValue=\"port\"/>\n                        </L7p:SetVariable>\n                    </wsp:All>\n                    <wsp:All wsp:Usage=\"Required\">\n                        <L7p:ComparisonAssertion>\n                            <L7p:Expression1 stringValue=\"${url_sub_string[1]}\"/>\n                            <L7p:Expression2 stringValue=\"https\"/>\n                            <L7p:Predicates predicates=\"included\">\n                                <L7p:item binary=\"included\">\n                                    <L7p:RightValue stringValue=\"https\"/>\n                                </L7p:item>\n                            </L7p:Predicates>\n                        </L7p:ComparisonAssertion>\n                        <L7p:SetVariable>\n                            <L7p:Base64Expression stringValue=\"NDQz\"/>\n                            <L7p:VariableToSet stringValue=\"port\"/>\n                        </L7p:SetVariable>\n                    </wsp:All>\n                    <L7p:assertionComment>\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"Use default port\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:assertionComment>\n                </wsp:OneOrMore>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"port is not specified\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Get hostname and port number\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:Regex>\n                    <L7p:AssertionComment assertionComment=\"included\">\n                        <L7p:Properties mapValue=\"included\">\n                            <L7p:entry>\n                                <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                                <L7p:value stringValue=\"Check if there are any uppercases in hostname\"/>\n                            </L7p:entry>\n                        </L7p:Properties>\n                    </L7p:AssertionComment>\n                    <L7p:AutoTarget booleanValue=\"false\"/>\n                    <L7p:FindAll booleanValue=\"true\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"host\"/>\n                    <L7p:Regex stringValue=\"[A-Z]\"/>\n                    <L7p:RegexName stringValue=\"Check for uppercase\"/>\n                    <L7p:Replacement stringValue=\"\"/>\n                    <L7p:Target target=\"OTHER\"/>\n                </L7p:Regex>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"PGhvc3RuYW1lPiR7aG9zdH08L2hvc3RuYW1lPg==\"/>\n                    <L7p:VariableToSet stringValue=\"xml\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHt4bWx9\"/>\n                    <L7p:ContentType stringValue=\"text/xml;charset=UTF-8\"/>\n                    <L7p:DataType variableDataType=\"message\"/>\n                    <L7p:VariableToSet stringValue=\"forXSL\"/>\n                </L7p:SetVariable>\n                <L7p:XslTransformation>\n                    <L7p:Direction intValue=\"-1\"/>\n                    <L7p:OtherTargetMessageVariable stringValue=\"forXSL\"/>\n                    <L7p:ResourceInfo staticResourceInfo=\"included\">\n                        <L7p:Document stringValueReference=\"inline\"><![CDATA[<xsl:stylesheet version=\"1.0\"\n                xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n                <xsl:output method=\"text\" omit-xml-declaration=\"yes\"/>\n\n                <xsl:variable name=\"lowercase\" select=\"'abcdefghijklmnopqrstuvwxyz'\"/>\n                <xsl:variable name=\"uppercase\" select=\"'ABCDEFGHIJKLMNOPQRSTUVWXYZ'\"/>\n\n                <xsl:template match=\"/hostname\">\n                <xsl:value-of select=\"translate(., $uppercase, $lowercase)\"/>\n                </xsl:template>\n\n                </xsl:stylesheet>]]></L7p:Document>\n                    </L7p:ResourceInfo>\n                    <L7p:Target target=\"OTHER\"/>\n                    <L7p:TransformName stringValue=\"\"/>\n                </L7p:XslTransformation>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHtmb3JYU0wubWFpbnBhcnR9\"/>\n                    <L7p:VariableToSet stringValue=\"host\"/>\n                </L7p:SetVariable>\n            </wsp:All>\n            <L7p:TrueAssertion/>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Change hostname to lowercase\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${request_uri}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${host}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:ComparisonAssertion>\n            <L7p:Expression1 stringValue=\"${port}\"/>\n            <L7p:Expression2 stringValue=\"\"/>\n            <L7p:Negate booleanValue=\"true\"/>\n            <L7p:Operator operator=\"EMPTY\"/>\n            <L7p:Predicates predicates=\"included\">\n                <L7p:item binary=\"included\">\n                    <L7p:Negated booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:RightValue stringValue=\"\"/>\n                </L7p:item>\n            </L7p:Predicates>\n        </L7p:ComparisonAssertion>\n        <L7p:EncodeDecode>\n            <L7p:SourceVariableName stringValue=\"request_uri\"/>\n            <L7p:TargetDataType variableDataType=\"string\"/>\n            <L7p:TargetVariableName stringValue=\"request_uri\"/>\n            <L7p:TransformType transformType=\"URL_ENCODE\"/>\n        </L7p:EncodeDecode>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"\"/>\n            <L7p:LineBreak lineBreak=\"LF\"/>\n            <L7p:VariableToSet stringValue=\"empty_line\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHt0aW1lc3RhbXBfc2VjfQ0KJHtub25jZX0NCiR7aHR0cF9tZXRob2R9DQoke3JlcXVlc3RfdXJpfQ0KJHtob3N0fQ0KJHtwb3J0fQ0KJHtleHR9DQoke2VtcHR5X2xpbmV9\"/>\n            <L7p:VariableToSet stringValue=\"normalized_request\"/>\n        </L7p:SetVariable>\n        <L7p:GenerateSecurityHash>\n            <L7p:Base64Data stringValue=\"JHtub3JtYWxpemVkX3JlcXVlc3R9\"/>\n            <L7p:KeyText stringValue=\"${mac_key}\"/>\n            <L7p:LineBreak lineBreak=\"CR-LF\"/>\n            <L7p:TargetOutputVariable stringValue=\"mac\"/>\n        </L7p:GenerateSecurityHash>\n        <L7p:ExportVariables>\n            <L7p:ExportedVars stringArrayValue=\"included\">\n                <L7p:item stringValue=\"mac\"/>\n            </L7p:ExportedVars>\n        </L7p:ExportVariables>\n    </wsp:All>\n</wsp:Policy>"
  }
}