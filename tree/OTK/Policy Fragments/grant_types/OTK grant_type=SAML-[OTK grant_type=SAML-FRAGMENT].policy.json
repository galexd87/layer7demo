{
  "goid": "e001cfd0c1c1ffaa18e187b5e72fd8ce",
  "guid": "315b5fe2-72f6-493d-8c1e-77e53d781113",
  "name": "OTK grant_type=SAML",
  "policyType": "FRAGMENT",
  "checksum": "2da9feb4e38f885ceef243c0a14561b3cef813f7",
  "folderPath": "/OTK/Policy Fragments/grant_types",
  "soap": false,
  "policy": {
    "xml": "<wsp:Policy xmlns:L7p=\"http://www.layer7tech.com/ws/policy\" xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2002/12/policy\">\n    <wsp:All wsp:Usage=\"Required\">\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === ***  THIS POLICY IS READ ONLY ***\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === Required changes can be implemented in policies in the 'Customizations' folder \"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === The policies within that folder will have the same name as this policy but \"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === either prefixed with '#' or suffixed with 'Extensions'\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === Prefixed policies can be used to overwrite variables of this policy\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === Suffixed policies can be used to extend functionality\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === If you find you cannot add your customizations using the policies in the 'Customizations' folder\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" === please contact CA APIM Support so we can improve customization capability\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\" ============================================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"This policy can be found and should be used as 'Encapsulated Assertion'!\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"Grant Type: urn:ietf:params:oauth:grant-type:saml2-bearer\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"This is an OAuth extension\"/>\n        </L7p:CommentAssertion>\n        <L7p:Encapsulated>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"2e6e2ef3-a36f-4548-a2c4-7b369b7ae184\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK Variable Configuration\"/>\n        </L7p:Encapsulated>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${assertion}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:ComparisonAssertion>\n                    <L7p:Expression1 stringValue=\"${scope}\"/>\n                    <L7p:Expression2 stringValue=\"\"/>\n                    <L7p:Negate booleanValue=\"true\"/>\n                    <L7p:Operator operator=\"EMPTY\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:Negated booleanValue=\"true\"/>\n                            <L7p:Operator operator=\"EMPTY\"/>\n                            <L7p:RightValue stringValue=\"\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MTAz\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Check for required variables\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Validation of the SAML assertion ==========\"/>\n        </L7p:CommentAssertion>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHthc3NlcnRpb259\"/>\n            <L7p:VariableToSet stringValue=\"bearerToken\"/>\n        </L7p:SetVariable>\n        <L7p:EncodeDecode>\n            <L7p:CharacterEncoding stringValueNull=\"null\"/>\n            <L7p:SourceVariableName stringValue=\"bearerToken\"/>\n            <L7p:TargetContentType stringValue=\"text/xml;charset=UTF-8\"/>\n            <L7p:TargetDataType variableDataType=\"message\"/>\n            <L7p:TargetVariableName stringValue=\"bearerToken\"/>\n            <L7p:TransformType transformType=\"BASE64_DECODE\"/>\n        </L7p:EncodeDecode>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <L7p:ValidateNonSoapSamlToken>\n                <L7p:AudienceRestriction stringValue=\"${conditions}\"/>\n                <L7p:AuthenticationStatement samlAuthenticationInfo=\"included\">\n                    <L7p:AuthenticationMethods stringArrayValue=\"included\">\n                        <L7p:item stringValue=\"urn:ietf:rfc:1510\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:MobileTwoFactorContract\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:am:unspecified\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:am:SPKI\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:am:X509-PKI\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:Smartcard\"/>\n                        <L7p:item stringValue=\"urn:ietf:rfc:3075\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:TimeSyncToken\"/>\n                        <L7p:item stringValue=\"urn:ietf:rfc:2945\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:SmartcardPKI\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:PreviousSession\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:MobileTwoFactorUnregistered\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:MobileOneFactorContract\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:NomadTelephony\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:MobileOneFactorUnregistered\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:AuthenticatedTelephony\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:am:PGP\"/>\n                        <L7p:item stringValue=\"urn:ietf:rfc:2246\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:PersonalizedTelephony\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:InternetProtocol\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:Telephony\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:InternetProtocolPassword\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:2.0:ac:classes:SoftwarePKI\"/>\n                        <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:am:password\"/>\n                    </L7p:AuthenticationMethods>\n                </L7p:AuthenticationStatement>\n                <L7p:MaxExpiry longValue=\"3600000\"/>\n                <L7p:NameFormats stringArrayValue=\"included\">\n                    <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\"/>\n                </L7p:NameFormats>\n                <L7p:NameQualifier stringValue=\"\"/>\n                <L7p:OtherTargetMessageVariable stringValue=\"bearerToken\"/>\n                <L7p:SubjectConfirmationDataCheckValidity booleanValue=\"false\"/>\n                <L7p:SubjectConfirmationDataRecipient stringValue=\"${receipient}\"/>\n                <L7p:SubjectConfirmations stringArrayValue=\"included\">\n                    <L7p:item stringValue=\"urn:oasis:names:tc:SAML:1.0:cm:bearer\"/>\n                </L7p:SubjectConfirmations>\n                <L7p:Target target=\"OTHER\"/>\n                <L7p:Version boxedIntegerValue=\"2\"/>\n            </L7p:ValidateNonSoapSamlToken>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"MjAy\"/>\n                    <L7p:VariableToSet stringValue=\"error.code\"/>\n                </L7p:SetVariable>\n                <L7p:FalseAssertion/>\n            </wsp:All>\n        </wsp:OneOrMore>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"== To implement SAML Authentication, edit the &quot;OTK grant_type=SAML Authentication&quot; policy.\"/>\n        </L7p:CommentAssertion>\n        <L7p:Include>\n            <L7p:PolicyGuid stringValue=\"59b9ada1-ac0f-4e8d-a6d4-ddb7544e9eca\"/>\n        </L7p:Include>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"============================\"/>\n        </L7p:CommentAssertion>\n        <L7p:CommentAssertion>\n            <L7p:Comment stringValue=\"========== Get Subject Name ID from SAML token ==========\"/>\n        </L7p:CommentAssertion>\n        <L7p:ResponseXpathAssertion>\n            <L7p:VariablePrefix stringValue=\"\"/>\n            <L7p:XmlMsgSrc stringValue=\"bearerToken\"/>\n            <L7p:XpathExpression xpathExpressionValue=\"included\">\n                <L7p:Expression stringValue=\"/saml2:Assertion/saml2:Subject/saml2:NameID\"/>\n                <L7p:Namespaces mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"saml2\"/>\n                        <L7p:value stringValue=\"urn:oasis:names:tc:SAML:2.0:assertion\"/>\n                    </L7p:entry>\n                </L7p:Namespaces>\n            </L7p:XpathExpression>\n        </L7p:ResponseXpathAssertion>\n        <L7p:Regex>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"LEFT.COMMENT\"/>\n                        <L7p:value stringValue=\"openid not permitted\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:AutoTarget booleanValue=\"false\"/>\n            <L7p:OtherTargetMessageVariable stringValue=\"scope\"/>\n            <L7p:Regex stringValue=\"\\bopenid\\b[ ]|\\bopenid\\b|[ ]\\bopenid\\b\"/>\n            <L7p:Replace booleanValue=\"true\"/>\n            <L7p:Replacement stringValue=\"\"/>\n            <L7p:Target target=\"OTHER\"/>\n        </L7p:Regex>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtzY29wZX0=\"/>\n            <L7p:VariableToSet stringValue=\"scope.granted\"/>\n        </L7p:SetVariable>\n        <L7p:SetVariable>\n            <L7p:Base64Expression stringValue=\"JHtyZXNwb25zZVhwYXRoLnJlc3VsdH0=\"/>\n            <L7p:VariableToSet stringValue=\"owner\"/>\n        </L7p:SetVariable>\n        <L7p:Encapsulated>\n            <L7p:AssertionComment assertionComment=\"included\">\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Convert resource sting to json array.\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:AssertionComment>\n            <L7p:EncapsulatedAssertionConfigGuid stringValue=\"1c378348-af09-48a5-89cf-f13449b3defe\"/>\n            <L7p:EncapsulatedAssertionConfigName stringValue=\"OTK CSV To JSON Array\"/>\n            <L7p:Parameters mapValue=\"included\">\n                <L7p:entry>\n                    <L7p:key stringValue=\"string\"/>\n                    <L7p:value stringValue=\"${resource.granted}\"/>\n                </L7p:entry>\n            </L7p:Parameters>\n        </L7p:Encapsulated>\n        <wsp:OneOrMore wsp:Usage=\"Required\">\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:ComparisonAssertion>\n                    <L7p:CaseSensitive booleanValue=\"false\"/>\n                    <L7p:Expression1 stringValue=\"${oauth2_token_type}\"/>\n                    <L7p:Expression2 stringValue=\"BEARER\"/>\n                    <L7p:Predicates predicates=\"included\">\n                        <L7p:item binary=\"included\">\n                            <L7p:CaseSensitive booleanValue=\"false\"/>\n                            <L7p:RightValue stringValue=\"BEARER\"/>\n                        </L7p:item>\n                    </L7p:Predicates>\n                </L7p:ComparisonAssertion>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"ew0KICAiYWNjZXNzX3Rva2VuIjoiJHthdF90b2tlbn0iLA0KICAidG9rZW5fdHlwZSI6IkJlYXJlciIsDQogICJleHBpcmVzX2luIjoke2F0X2xpZmV0aW1lfSwNCiAgInNjb3BlIjoiJHtzY29wZS5ncmFudGVkfSIsDQogICJyZXNvdXJjZSI6ICR7b3V0cHV0X2pzb259DQp9\"/>\n                    <L7p:VariableToSet stringValue=\"clientResponse\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"\"/>\n                    <L7p:VariableToSet stringValue=\"token_secret\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"token_type=BEARER\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <wsp:All wsp:Usage=\"Required\">\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"ew0KICAiYWNjZXNzX3Rva2VuIjoiJHthdF90b2tlbn0iLA0KICAidG9rZW5fdHlwZSI6Im1hYyIsDQogICJleHBpcmVzX2luIjoke2F0X2xpZmV0aW1lfSwNCiAgInNjb3BlIjoiJHtzY29wZS5ncmFudGVkfSIsDQogICJtYWNfa2V5IjoiJHttYWNfc2VjcmV0fSIsDQogICJtYWNfYWxnb3JpdGhtIjoiaG1hYy1zaGEtMSINCn0=\"/>\n                    <L7p:VariableToSet stringValue=\"clientResponse\"/>\n                </L7p:SetVariable>\n                <L7p:SetVariable>\n                    <L7p:Base64Expression stringValue=\"JHttYWNfc2VjcmV0fQ==\"/>\n                    <L7p:VariableToSet stringValue=\"token_secret\"/>\n                </L7p:SetVariable>\n                <L7p:assertionComment>\n                    <L7p:Properties mapValue=\"included\">\n                        <L7p:entry>\n                            <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                            <L7p:value stringValue=\"token_type=MAC\"/>\n                        </L7p:entry>\n                    </L7p:Properties>\n                </L7p:assertionComment>\n            </wsp:All>\n            <L7p:assertionComment>\n                <L7p:Properties mapValue=\"included\">\n                    <L7p:entry>\n                        <L7p:key stringValue=\"RIGHT.COMMENT\"/>\n                        <L7p:value stringValue=\"Create tokens\"/>\n                    </L7p:entry>\n                </L7p:Properties>\n            </L7p:assertionComment>\n        </wsp:OneOrMore>\n    </wsp:All>\n</wsp:Policy>"
  }
}